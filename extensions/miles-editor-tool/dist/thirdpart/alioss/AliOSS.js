"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AliOSS = void 0;
/**
应当在工程settings目录保存ali_oss_config.json文件，格式为
{
    "accessKeyId": "",
    "accessKeySecret": "",
    "region": "",
    "bucket": ""
}
*/
const ali_oss_1 = __importDefault(require("ali-oss"));
const fs_extra_1 = __importDefault(require("fs-extra"));
const path_1 = __importDefault(require("path"));
const BuildLogger_1 = require("../../builder/BuildLogger");
const Constant_1 = require("../../tools/Constant");
const Utils_1 = require("../../tools/Utils");
/** 上传文件时 在元数据保留最后修改时间 方便上传时比较 */
const mTimeKey = "x-oss-meta-last-modified";
const tag = "[AliOSS]";
/** 上传并发数量 */
const concurrent = 10;
/** 文件上传失败重试次数 */
const retry = 3;
let endResolve;
/** 阿里云oss上传工具 */
class AliOSS {
    /**
     * 上传本地资源目录到oss指定目录
     * @param localDir 本地资源目录地址
     * @param ossDir OSS目录地址 例：需要上传到(oss://bucketName/Test/) 此时应该填(Test/) 不需要包含前面的部分
     */
    constructor(localDir, ossDir) {
        /** OSS客户端 */
        this.client = null;
        this.localDir = "";
        this.ossDir = "";
        /** 文件重试次数 */
        this.retryCnt = new Map();
        this.startTimeMS = 0;
        this.totalCnt = 0; //总共数量
        this.succCnt = 0; //成功数量
        this.failCnt = 0; //失败数量
        this.skipCnt = 0; //跳过数量
        this.percent = 0.1;
        this.localDir = Utils_1.Utils.toUniSeparator(localDir);
        this.ossDir = ossDir;
    }
    /**
     * 上传资源
     * @param taskName 构建任务名字(可能不同的构建任务需要上传到不同的OSS)
     * @param files 需要上传的文件
     */
    async upload(taskName, files) {
        let p = new Promise((resolve, reject) => {
            let configPath = taskName + "_" + Constant_1.Constant.AliOSSConfigFilePath;
            if (!fs_extra_1.default.existsSync(configPath)) {
                configPath = Constant_1.Constant.AliOSSConfigFilePath;
            }
            if (!fs_extra_1.default.existsSync(configPath)) {
                BuildLogger_1.BuildLogger.info(tag, "ali_oss_config.json文件不存在,跳过上传");
                return;
            }
            try {
                let config = fs_extra_1.default.readJSONSync(configPath);
                let ossDirPrefix = config['ossDirPrefix'];
                if (ossDirPrefix)
                    this.ossDir = Utils_1.Utils.toUniSeparator(path_1.default.join(ossDirPrefix, this.ossDir));
                this.client = new ali_oss_1.default(config);
            }
            catch (e) {
                BuildLogger_1.BuildLogger.error(e);
                resolve();
                return;
            }
            BuildLogger_1.BuildLogger.info(tag, `LocalDir=${this.localDir} OSSDir=${this.ossDir}`);
            this.remainFiles = files;
            this.totalCnt = this.remainFiles.length;
            this.startTimeMS = Date.now();
            BuildLogger_1.BuildLogger.info(tag, `正在上传中 请耐心等待 文件数量:${this.totalCnt}`);
            for (let i = 0; i < concurrent; i++) {
                if (this.remainFiles.length > 0) {
                    this.uploadFile(this.remainFiles.pop());
                }
            }
            endResolve = resolve;
        });
        return p;
    }
    /** 文件是否已经存在OSS中 */
    async isFileExistsInOss(localPath) {
        let remotePath = this.localToOssPath(localPath);
        BuildLogger_1.BuildLogger.info(tag, localPath, remotePath);
        try {
            const result = await this.client.head(remotePath);
            return true;
        }
        catch (e) {
            return false;
        }
    }
    localToOssPath(file) {
        let dirName = path_1.default.basename(this.localDir);
        let suffix = file.replace(this.localDir, dirName);
        let remotePath = Utils_1.Utils.toUniSeparator(path_1.default.join(this.ossDir, suffix));
        return remotePath;
    }
    async uploadFile(localPath) {
        let remotePath = this.localToOssPath(localPath);
        const stat = fs_extra_1.default.statSync(localPath);
        const mTimeMS = stat.mtime.getTime();
        try {
            const result = await this.client.head(remotePath);
            let timeMS = result.res.headers[mTimeKey];
            let size = result.res.headers["content-length"];
            if (size == stat.size && timeMS == mTimeMS) {
                this.uploadEnded(localPath, 2);
                return;
            }
        }
        catch (e) { }
        try {
            const headers = { [mTimeKey]: mTimeMS };
            await this.client.put(remotePath, localPath, { headers: headers });
            this.uploadEnded(localPath, 1);
        }
        catch (err) {
            this.uploadEnded(localPath, 0, err);
        }
    }
    uploadEnded(file, code, err) {
        if (code == 0) { //失败重试检测
            let re = this.retryCnt.has(file) ? this.retryCnt.get(file) : retry;
            if (re > 0) {
                this.uploadFile(file);
                this.retryCnt.set(file, re - 1);
                return;
            }
            else {
                console.error(tag, `上传失败 ${file} `, err.message);
            }
        }
        if (code == 1)
            this.succCnt += 1;
        else if (code == 2)
            this.skipCnt += 1;
        else
            this.failCnt += 1;
        this.checkComplete();
    }
    checkComplete() {
        let complete = this.succCnt + this.failCnt + this.skipCnt;
        if (complete == Math.floor(this.totalCnt * this.percent)) { //达到某个进度时打印
            BuildLogger_1.BuildLogger.info(tag, `上传进度:${Math.round(this.percent * 100)}%`);
            this.percent += 0.1;
        }
        if (complete != this.totalCnt) { //未上传完成
            if (this.remainFiles.length > 0) {
                this.uploadFile(this.remainFiles.pop()); //继续上传
            }
            return;
        }
        //全部上传完成
        let dtTimeMS = Math.floor((Date.now() - this.startTimeMS) / 1000);
        if (this.failCnt > 0) {
            BuildLogger_1.BuildLogger.error(tag, `上传失败 总共:${this.totalCnt} 失败:${this.failCnt} 耗时:${dtTimeMS}秒`);
        }
        else {
            BuildLogger_1.BuildLogger.info(tag, `上传成功 总共:${this.totalCnt} 上传:${this.succCnt} 跳过:${this.skipCnt} 耗时:${dtTimeMS}秒`);
        }
        endResolve();
    }
}
exports.AliOSS = AliOSS;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWxpT1NTLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc291cmNlL3RoaXJkcGFydC9hbGlvc3MvQWxpT1NTLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBOzs7Ozs7OztFQVFFO0FBQ0Ysc0RBQTBCO0FBQzFCLHdEQUEwQjtBQUMxQixnREFBd0I7QUFDeEIsMkRBQXdEO0FBQ3hELG1EQUFnRDtBQUNoRCw2Q0FBMEM7QUFFMUMsaUNBQWlDO0FBQ2pDLE1BQU0sUUFBUSxHQUFHLDBCQUEwQixDQUFDO0FBRTVDLE1BQU0sR0FBRyxHQUFHLFVBQVUsQ0FBQztBQUV2QixhQUFhO0FBQ2IsTUFBTSxVQUFVLEdBQUcsRUFBRSxDQUFDO0FBRXRCLGlCQUFpQjtBQUNqQixNQUFNLEtBQUssR0FBRyxDQUFDLENBQUM7QUFFaEIsSUFBSSxVQUFvQixDQUFDO0FBR3pCLGlCQUFpQjtBQUNqQixNQUFhLE1BQU07SUFzQmY7Ozs7T0FJRztJQUNILFlBQVksUUFBZ0IsRUFBRSxNQUFjO1FBekI1QyxhQUFhO1FBQ0wsV0FBTSxHQUFRLElBQUksQ0FBQztRQUVuQixhQUFRLEdBQVcsRUFBRSxDQUFDO1FBQ3RCLFdBQU0sR0FBVyxFQUFFLENBQUM7UUFLNUIsYUFBYTtRQUNMLGFBQVEsR0FBd0IsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUkxQyxnQkFBVyxHQUFHLENBQUMsQ0FBQztRQUNoQixhQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUEsTUFBTTtRQUNuQixZQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUEsTUFBTTtRQUNsQixZQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUEsTUFBTTtRQUNsQixZQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUEsTUFBTTtRQXVHbEIsWUFBTyxHQUFHLEdBQUcsQ0FBQztRQS9GbEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxhQUFLLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQy9DLElBQUksQ0FBQyxNQUFNLEdB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TyxJQUFJLENBQUMsT0FBTyxPQUFPLFFBQVEsR0FBRyxDQUFDLENBQUM7U0FDM0c7UUFDRCxVQUFVLEVBQUUsQ0FBQztJQUNqQixDQUFDO0NBRUo7QUF4S0Qsd0JBd0tDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG7lupTlvZPlnKjlt6XnqItzZXR0aW5nc+ebruW9leS/neWtmGFsaV9vc3NfY29uZmlnLmpzb27mlofku7bvvIzmoLzlvI/kuLpcbntcbiAgICBcImFjY2Vzc0tleUlkXCI6IFwiXCIsXG4gICAgXCJhY2Nlc3NLZXlTZWNyZXRcIjogXCJcIixcbiAgICBcInJlZ2lvblwiOiBcIlwiLFxuICAgIFwiYnVja2V0XCI6IFwiXCJcbn1cbiovXG5pbXBvcnQgT1NTIGZyb20gXCJhbGktb3NzXCI7XG5pbXBvcnQgZnMgZnJvbSBcImZzLWV4dHJhXCI7XG5pbXBvcnQgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgQnVpbGRMb2dnZXIgfSBmcm9tIFwiLi4vLi4vYnVpbGRlci9CdWlsZExvZ2dlclwiO1xuaW1wb3J0IHsgQ29uc3RhbnQgfSBmcm9tIFwiLi4vLi4vdG9vbHMvQ29uc3RhbnRcIjtcbmltcG9ydCB7IFV0aWxzIH0gZnJvbSBcIi4uLy4uL3Rvb2xzL1V0aWxzXCI7XG5cbi8qKiDkuIrkvKDmlofku7bml7Yg5Zyo5YWD5pWw5o2u5L+d55WZ5pyA5ZCO5L+u5pS55pe26Ze0IOaWueS+v+S4iuS8oOaXtuavlOi+gyAqL1xuY29uc3QgbVRpbWVLZXkgPSBcIngtb3NzLW1ldGEtbGFzdC1tb2RpZmllZFwiO1xuXG5jb25zdCB0YWcgPSBcIltBbGlPU1NdXCI7XG5cbi8qKiDkuIrkvKDlubblj5HmlbDph48gKi9cbmNvbnN0IGNvbmN1cnJlbnQgPSAxMDtcblxuLyoqIOaWh+S7tuS4iuS8oOWksei0pemHjeivleasoeaVsCAqL1xuY29uc3QgcmV0cnkgPSAzO1xuXG5sZXQgZW5kUmVzb2x2ZTogRnVuY3Rpb247XG5cblxuLyoqIOmYv+mHjOS6kW9zc+S4iuS8oOW3peWFtyAqL1xuZXhwb3J0IGNsYXNzIEFsaU9TUyB7XG5cbiAgICAvKiogT1NT5a6i5oi356uvICovXG4gICAgcHJpdmF0ZSBjbGllbnQ6IE9TUyA9IG51bGw7XG5cbiAgICBwcml2YXRlIGxvY2FsRGlyOiBzdHJpbmcgPSBcIlwiO1xuICAgIHByaXZhdGUgb3NzRGlyOiBzdHJpbmcgPSBcIlwiO1xuXG4gICAgLyoqIOWJqeS9meaWh+S7tiAqL1xuICAgIHByaXZhdGUgcmVtYWluRmlsZXM6IHN0cmluZ1tdO1xuXG4gICAgLyoqIOaWh+S7tumHjeivleasoeaVsCAqL1xuICAgIHByaXZhdGUgcmV0cnlDbnQ6IE1hcDxzdHJpbmcsIG51bWJlcj4gPSBuZXcgTWFwKCk7XG5cblxuXG4gICAgcHJpdmF0ZSBzdGFydFRpbWVNUyA9IDA7XG4gICAgcHJpdmF0ZSB0b3RhbENudCA9IDA7Ly/mgLvlhbHmlbDph49cbiAgICBwcml2YXRlIHN1Y2NDbnQgPSAwOy8v5oiQ5Yqf5pWw6YePXG4gICAgcHJpdmF0ZSBmYWlsQ250ID0gMDsvL+Wksei0peaVsOmHj1xuICAgIHByaXZhdGUgc2tpcENudCA9IDA7Ly/ot7Pov4fmlbDph49cblxuICAgIC8qKlxuICAgICAqIOS4iuS8oOacrOWcsOi1hOa6kOebruW9leWIsG9zc+aMh+WumuebruW9lVxuICAgICAqIEBwYXJhbSBsb2NhbERpciDmnKzlnLDotYTmupDnm67lvZXlnLDlnYBcbiAgICAgKiBAcGFyYW0gb3NzRGlyIE9TU+ebruW9leWcsOWdgCDkvovvvJrpnIDopoHkuIrkvKDliLAob3NzOi8vYnVja2V0TmFtZS9UZXN0Lykg5q2k5pe25bqU6K+l5aGrKFRlc3QvKSDkuI3pnIDopoHljIXlkKvliY3pnaLnmoTpg6jliIZcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihsb2NhbERpcjogc3RyaW5nLCBvc3NEaXI6IHN0cmluZykge1xuICAgICAgICB0aGlzLmxvY2FsRGlyID0gVXRpbHMudG9VbmlTZXBhcmF0b3IobG9jYWxEaXIpO1xuICAgICAgICB0aGlzLm9zc0RpciA9IG9zc0RpcjtcbiAgICB9XG5cblxuICAgIC8qKlxuICAgICAqIOS4iuS8oOi1hOa6kFxuICAgICAqIEBwYXJhbSB0YXNrTmFtZSDmnoTlu7rku7vliqHlkI3lrZco5Y+v6IO95LiN5ZCM55qE5p6E5bu65Lu75Yqh6ZyA6KaB5LiK5Lyg5Yiw5LiN5ZCM55qET1NTKVxuICAgICAqIEBwYXJhbSBmaWxlcyDpnIDopoHkuIrkvKDnmoTmlofku7ZcbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgdXBsb2FkKHRhc2tOYW1lOiBzdHJpbmcsIGZpbGVzOiBzdHJpbmdbXSkge1xuXG4gICAgICAgIGxldCBwID0gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgbGV0IGNvbmZpZ1BhdGggPSB0YXNrTmFtZSArIFwiX1wiICsgQ29uc3RhbnQuQWxpT1NTQ29uZmlnRmlsZVBhdGg7XG4gICAgICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoY29uZmlnUGF0aCkpIHtcbiAgICAgICAgICAgICAgICBjb25maWdQYXRoID0gQ29uc3RhbnQuQWxpT1NTQ29uZmlnRmlsZVBhdGg7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoY29uZmlnUGF0aCkpIHtcbiAgICAgICAgICAgICAgICBCdWlsZExvZ2dlci5pbmZvKHRhZywgXCJhbGlfb3NzX2NvbmZpZy5qc29u5paH5Lu25LiN5a2Y5ZyoLOi3s+i/h+S4iuS8oFwiKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGxldCBjb25maWcgPSBmcy5yZWFkSlNPTlN5bmMoY29uZmlnUGF0aCk7XG4gICAgICAgICAgICAgICAgbGV0IG9zc0RpclByZWZpeCA9IGNvbmZpZ1snb3NzRGlyUHJlZml4J107XG4gICAgICAgICAgICAgICAgaWYgKG9zc0RpclByZWZpeCkgdGhpcy5vc3NEaXIgPSBVdGlscy50b1VuaVNlcGFyYXRvcihwYXRoLmpvaW4ob3NzRGlyUHJlZml4LCB0aGlzLm9zc0RpcikpO1xuICAgICAgICAgICAgICAgIHRoaXMuY2xpZW50ID0gbmV3IE9TUyhjb25maWcpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIEJ1aWxkTG9nZ2VyLmVycm9yKGUpO1xuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIEJ1aWxkTG9nZ2VyLmluZm8odGFnLCBgTG9jYWxEaXI9JHt0aGlzLmxvY2FsRGlyfSBPU1NEaXI9JHt0aGlzLm9zc0Rpcn1gKTtcbiAgICAgICAgICAgIHRoaXMucmVtYWluRmlsZXMgPSBmaWxlcztcblxuICAgICAgICAgICAgdGhpcy50b3RhbENudCA9IHRoaXMucmVtYWluRmlsZXMubGVuZ3RoO1xuICAgICAgICAgICAgdGhpcy5zdGFydFRpbWVNUyA9IERhdGUubm93KCk7XG5cbiAgICAgICAgICAgIEJ1aWxkTG9nZ2VyLmluZm8odGFnLCBg5q2j5Zyo5LiK5Lyg5LitIOivt+iAkOW/g+etieW+hSDmlofku7bmlbDph486JHt0aGlzLnRvdGFsQ250fWApO1xuXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvbmN1cnJlbnQ7IGkrKykge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlbWFpbkZpbGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGxvYWRGaWxlKHRoaXMucmVtYWluRmlsZXMucG9wKCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZW5kUmVzb2x2ZSA9IHJlc29sdmU7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBwO1xuICAgIH1cblxuICAgIC8qKiDmlofku7bmmK/lkKblt7Lnu4/lrZjlnKhPU1PkuK0gKi9cbiAgICBwdWJsaWMgYXN5bmMgaXNGaWxlRXhpc3RzSW5Pc3MobG9jYWxQYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IHJlbW90ZVBhdGggPSB0aGlzLmxvY2FsVG9Pc3NQYXRoKGxvY2FsUGF0aCk7XG4gICAgICAgIEJ1aWxkTG9nZ2VyLmluZm8odGFnLCBsb2NhbFBhdGgsIHJlbW90ZVBhdGgpXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmNsaWVudC5oZWFkKHJlbW90ZVBhdGgpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuXG4gICAgcHJpdmF0ZSBsb2NhbFRvT3NzUGF0aChmaWxlOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IGRpck5hbWUgPSBwYXRoLmJhc2VuYW1lKHRoaXMubG9jYWxEaXIpO1xuICAgICAgICBsZXQgc3VmZml4ID0gZmlsZS5yZXBsYWNlKHRoaXMubG9jYWxEaXIsIGRpck5hbWUpO1xuICAgICAgICBsZXQgcmVtb3RlUGF0aCA9IFV0aWxzLnRvVW5pU2VwYXJhdG9yKHBhdGguam9pbih0aGlzLm9zc0Rpciwgc3VmZml4KSk7XG4gICAgICAgIHJldHVybiByZW1vdGVQYXRoO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgdXBsb2FkRmlsZShsb2NhbFBhdGg6IHN0cmluZykge1xuICAgICAgICBsZXQgcmVtb3RlUGF0aCA9IHRoaXMubG9jYWxUb09zc1BhdGgobG9jYWxQYXRoKTtcbiAgICAgICAgY29uc3Qgc3RhdCA9IGZzLnN0YXRTeW5jKGxvY2FsUGF0aCk7XG4gICAgICAgIGNvbnN0IG1UaW1lTVMgPSBzdGF0Lm10aW1lLmdldFRpbWUoKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuY2xpZW50LmhlYWQocmVtb3RlUGF0aCk7XG4gICAgICAgICAgICBsZXQgdGltZU1TOiBudW1iZXIgPSByZXN1bHQucmVzLmhlYWRlcnNbbVRpbWVLZXldO1xuICAgICAgICAgICAgbGV0IHNpemU6IG51bWJlciA9IHJlc3VsdC5yZXMuaGVhZGVyc1tcImNvbnRlbnQtbGVuZ3RoXCJdO1xuICAgICAgICAgICAgaWYgKHNpemUgPT0gc3RhdC5zaXplICYmIHRpbWVNUyA9PSBtVGltZU1TKSB7XG4gICAgICAgICAgICAgICAgdGhpcy51cGxvYWRFbmRlZChsb2NhbFBhdGgsIDIpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZSkgeyB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGhlYWRlcnMgPSB7IFttVGltZUtleV06IG1UaW1lTVMgfVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5jbGllbnQucHV0KHJlbW90ZVBhdGgsIGxvY2FsUGF0aCwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pO1xuICAgICAgICAgICAgdGhpcy51cGxvYWRFbmRlZChsb2NhbFBhdGgsIDEpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHRoaXMudXBsb2FkRW5kZWQobG9jYWxQYXRoLCAwLCBlcnIpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwZXJjZW50ID0gMC4xO1xuICAgIHByaXZhdGUgdXBsb2FkRW5kZWQoZmlsZTogc3RyaW5nLCBjb2RlOiBudW1iZXIsIGVycj86IEVycm9yKSB7XG4gICAgICAgIGlmIChjb2RlID09IDApIHsvL+Wksei0pemHjeivleajgOa1i1xuICAgICAgICAgICAgbGV0IHJlID0gdGhpcy5yZXRyeUNudC5oYXMoZmlsZSkgPyB0aGlzLnJldHJ5Q250LmdldChmaWxlKSA6IHJldHJ5O1xuICAgICAgICAgICAgaWYgKHJlID4gMCkge1xuICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkRmlsZShmaWxlKTtcbiAgICAgICAgICAgICAgICB0aGlzLnJldHJ5Q250LnNldChmaWxlLCByZSAtIDEpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcih0YWcsIGDkuIrkvKDlpLHotKUgJHtmaWxlfSBgLCBlcnIubWVzc2FnZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29kZSA9PSAxKSB0aGlzLnN1Y2NDbnQgKz0gMTtcbiAgICAgICAgZWxzZSBpZiAoY29kZSA9PSAyKSB0aGlzLnNraXBDbnQgKz0gMTtcbiAgICAgICAgZWxzZSB0aGlzLmZhaWxDbnQgKz0gMTtcblxuICAgICAgICB0aGlzLmNoZWNrQ29tcGxldGUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNoZWNrQ29tcGxldGUoKSB7XG4gICAgICAgIGxldCBjb21wbGV0ZSA9IHRoaXMuc3VjY0NudCArIHRoaXMuZmFpbENudCArIHRoaXMuc2tpcENudDtcblxuICAgICAgICBpZiAoY29tcGxldGUgPT0gTWF0aC5mbG9vcih0aGlzLnRvdGFsQ250ICogdGhpcy5wZXJjZW50KSkgey8v6L6+5Yiw5p+Q5Liq6L+b5bqm5pe25omT5Y2wXG4gICAgICAgICAgICBCdWlsZExvZ2dlci5pbmZvKHRhZywgYOS4iuS8oOi/m+W6pjoke01hdGgucm91bmQodGhpcy5wZXJjZW50ICogMTAwKX0lYCk7XG4gICAgICAgICAgICB0aGlzLnBlcmNlbnQgKz0gMC4xO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbXBsZXRlICE9IHRoaXMudG90YWxDbnQpIHsvL+acquS4iuS8oOWujOaIkFxuICAgICAgICAgICAgaWYgKHRoaXMucmVtYWluRmlsZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkRmlsZSh0aGlzLnJlbWFpbkZpbGVzLnBvcCgpKTsvL+e7p+e7reS4iuS8oFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy/lhajpg6jkuIrkvKDlrozmiJBcbiAgICAgICAgbGV0IGR0VGltZU1TID0gTWF0aC5mbG9vcigoRGF0ZS5ub3coKSAtIHRoaXMuc3RhcnRUaW1lTVMpIC8gMTAwMCk7XG4gICAgICAgIGlmICh0aGlzLmZhaWxDbnQgPiAwKSB7XG4gICAgICAgICAgICBCdWlsZExvZ2dlci5lcnJvcih0YWcsIGDkuIrkvKDlpLHotKUg5oC75YWxOiR7dGhpcy50b3RhbENudH0g5aSx6LSlOiR7dGhpcy5mYWlsQ250fSDogJfml7Y6JHtkdFRpbWVNU33np5JgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIEJ1aWxkTG9nZ2VyLmluZm8odGFnLCBg5LiK5Lyg5oiQ5YqfIOaAu+WFsToke3RoaXMudG90YWxDbnR9IOS4iuS8oDoke3RoaXMuc3VjY0NudH0g6Lez6L+HOiR7dGhpcy5za2lwQ250fSDogJfml7Y6JHtkdFRpbWVNU33np5JgKTtcbiAgICAgICAgfVxuICAgICAgICBlbmRSZXNvbHZlKCk7XG4gICAgfVxuXG59XG4iXX0=