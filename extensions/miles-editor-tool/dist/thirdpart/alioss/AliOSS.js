"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AliOSS = void 0;
/**
应当在工程settings目录保存ali_oss_config.json文件，格式为
{
    "accessKeyId": "",
    "accessKeySecret": "",
    "region": "",
    "bucket": ""
}
*/
const ali_oss_1 = __importDefault(require("ali-oss"));
const fs_extra_1 = __importDefault(require("fs-extra"));
const path_1 = __importDefault(require("path"));
const BuildLogger_1 = require("../../builder/BuildLogger");
const Constant_1 = require("../../tools/Constant");
const Utils_1 = require("../../tools/Utils");
/** 上传文件时 在元数据保留最后修改时间 方便上传时比较 */
const mTimeKey = "x-oss-meta-last-modified";
const tag = "[AliOSS]";
/** 上传并发数量 */
const concurrent = 10;
/** 文件上传失败重试次数 */
const retry = 3;
let endResolve;
/** 阿里云oss上传工具 */
class AliOSS {
    /**
     * 上传本地资源目录到oss指定目录
     * @param localDir 本地资源目录地址
     * @param ossDir OSS目录地址 例：需要上传到(oss://bucketName/Test/) 此时应该填(Test/) 不需要包含前面的部分
     */
    constructor(localDir, ossDir) {
        /** OSS客户端 */
        this.client = null;
        this.localDir = "";
        this.ossDir = "";
        /** 文件重试次数 */
        this.retryCnt = new Map();
        this.startTimeMS = 0;
        this.totalCnt = 0; //总共数量
        this.succCnt = 0; //成功数量
        this.failCnt = 0; //失败数量
        this.skipCnt = 0; //跳过数量
        this.percent = 0.1;
        this.localDir = Utils_1.Utils.toUniSeparator(localDir);
        this.ossDir = ossDir;
    }
    /**
     * 上传资源
     * @param taskName 构建任务名字(可能不同的构建任务需要上传到不同的OSS)
     * @param files 需要上传的文件
     */
    async upload(taskName, files) {
        if (!this.localDir) {
            BuildLogger_1.BuildLogger.error(tag, "本地资源目录为空");
            return;
        }
        if (!this.ossDir) {
            BuildLogger_1.BuildLogger.error(tag, "OSS目录为空");
            return;
        }
        let p = new Promise((resolve, reject) => {
            let configPath = Constant_1.Constant.AliOSSConfigFilePath.replace(".json", "_" + taskName + ".json");
            if (!fs_extra_1.default.existsSync(configPath)) {
                configPath = Constant_1.Constant.AliOSSConfigFilePath;
            }
            if (!fs_extra_1.default.existsSync(configPath)) {
                BuildLogger_1.BuildLogger.info(tag, "ali_oss_config.json文件不存在,跳过上传");
                return;
            }
            try {
                let config = fs_extra_1.default.readJSONSync(configPath);
                let ossDirPrefix = config['ossDirPrefix'];
                if (ossDirPrefix)
                    this.ossDir = Utils_1.Utils.toUniSeparator(path_1.default.join(ossDirPrefix, this.ossDir));
                this.client = new ali_oss_1.default(config);
            }
            catch (e) {
                BuildLogger_1.BuildLogger.error(e);
                resolve();
                return;
            }
            BuildLogger_1.BuildLogger.info(tag, `LocalDir=${this.localDir} OSSDir=${this.ossDir}`);
            this.remainFiles = files;
            this.totalCnt = this.remainFiles.length;
            this.startTimeMS = Date.now();
            BuildLogger_1.BuildLogger.info(tag, `正在上传中 请耐心等待 文件数量:${this.totalCnt}`);
            for (let i = 0; i < concurrent; i++) {
                if (this.remainFiles.length > 0) {
                    this.uploadFile(this.remainFiles.pop());
                }
            }
            endResolve = resolve;
        });
        return p;
    }
    localToOssPath(file) {
        let dirName = path_1.default.basename(this.localDir);
        let suffix = file.replace(this.localDir, dirName);
        let remotePath = Utils_1.Utils.toUniSeparator(path_1.default.join(this.ossDir, suffix));
        return remotePath;
    }
    async uploadFile(localPath) {
        let remotePath = this.localToOssPath(localPath);
        const stat = fs_extra_1.default.statSync(localPath);
        const mTimeMS = stat.mtime.getTime();
        try {
            const result = await this.client.head(remotePath);
            let timeMS = result.res.headers[mTimeKey];
            let size = result.res.headers["content-length"];
            if (size == stat.size && timeMS == mTimeMS) {
                this.uploadEnded(localPath, 2);
                return;
            }
        }
        catch (e) { }
        try {
            const headers = { [mTimeKey]: mTimeMS };
            await this.client.put(remotePath, localPath, { headers: headers });
            this.uploadEnded(localPath, 1);
        }
        catch (err) {
            this.uploadEnded(localPath, 0, err);
        }
    }
    uploadEnded(file, code, err) {
        if (code == 0) { //失败重试检测
            let re = this.retryCnt.has(file) ? this.retryCnt.get(file) : retry;
            if (re > 0) {
                this.uploadFile(file);
                this.retryCnt.set(file, re - 1);
                return;
            }
            else {
                console.error(tag, `上传失败 ${file} `, err.message);
            }
        }
        if (code == 1)
            this.succCnt += 1;
        else if (code == 2)
            this.skipCnt += 1;
        else
            this.failCnt += 1;
        this.checkComplete();
    }
    checkComplete() {
        let complete = this.succCnt + this.failCnt + this.skipCnt;
        if (complete == Math.floor(this.totalCnt * this.percent)) { //达到某个进度时打印
            BuildLogger_1.BuildLogger.info(tag, `上传进度:${Math.round(this.percent * 100)}%`);
            this.percent += 0.1;
        }
        if (complete != this.totalCnt) { //未上传完成
            if (this.remainFiles.length > 0) {
                this.uploadFile(this.remainFiles.pop()); //继续上传
            }
            return;
        }
        //全部上传完成
        let dtTimeMS = Math.floor((Date.now() - this.startTimeMS) / 1000);
        if (this.failCnt > 0) {
            BuildLogger_1.BuildLogger.error(tag, `上传失败 总共:${this.totalCnt} 失败:${this.failCnt} 耗时:${dtTimeMS}秒`);
        }
        else {
            BuildLogger_1.BuildLogger.info(tag, `上传成功 总共:${this.totalCnt} 上传:${this.succCnt} 跳过:${this.skipCnt} 耗时:${dtTimeMS}秒`);
        }
        endResolve();
    }
}
exports.AliOSS = AliOSS;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWxpT1NTLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc291cmNlL3RoaXJkcGFydC9hbGlvc3MvQWxpT1NTLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBOzs7Ozs7OztFQVFFO0FBQ0Ysc0RBQTBCO0FBQzFCLHdEQUEwQjtBQUMxQixnREFBd0I7QUFDeEIsMkRBQXdEO0FBQ3hELG1EQUFnRDtBQUNoRCw2Q0FBMEM7QUFFMUMsaUNBQWlDO0FBQ2pDLE1BQU0sUUFBUSxHQUFHLDBCQUEwQixDQUFDO0FBRTVDLE1BQU0sR0FBRyxHQUFHLFVBQVUsQ0FBQztBQUV2QixhQUFhO0FBQ2IsTUFBTSxVQUFVLEdBQUcsRUFBRSxDQUFDO0FBRXRCLGlCQUFpQjtBQUNqQixNQUFNLEtBQUssR0FBRyxDQUFDLENBQUM7QUFFaEIsSUFBSSxVQUFvQixDQUFDO0FBR3pCLGlCQUFpQjtBQUNqQixNQUFhLE1BQU07SUFzQmY7Ozs7T0FJRztJQUNILFlBQVksUUFBZ0IsRUFBRSxNQUFjO1FBekI1QyxhQUFhO1FBQ0wsV0FBTSxHQUFRLElBQUksQ0FBQztRQUVuQixhQUFRLEdBQVcsRUFBRSxDQUFDO1FBQ3RCLFdBQU0sR0FBVyxFQUFFLENBQUM7UUFLNUIsYUFBYTtRQUNMLGFBQVEsR0FBd0IsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUkxQyxnQkFBVyxHQUFHLENBQUMsQ0FBQztRQUNoQixhQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUEsTUFBTTtRQUNuQixZQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUEsTUFBTTtRQUNsQixZQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUEsTUFBTTtRQUNsQixZQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUEsTUFBTTtRQWtHbEIsWUFBTyxHQUFHLEdBQUcsQ0FBQztRQTFGbEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxhQUFLLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQy9DLElBQUksQ0FBQyxNQUFNLEdB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bktELHdCQW1LQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxu5bqU5b2T5Zyo5bel56iLc2V0dGluZ3Pnm67lvZXkv53lrZhhbGlfb3NzX2NvbmZpZy5qc29u5paH5Lu277yM5qC85byP5Li6XG57XG4gICAgXCJhY2Nlc3NLZXlJZFwiOiBcIlwiLFxuICAgIFwiYWNjZXNzS2V5U2VjcmV0XCI6IFwiXCIsXG4gICAgXCJyZWdpb25cIjogXCJcIixcbiAgICBcImJ1Y2tldFwiOiBcIlwiXG59XG4qL1xuaW1wb3J0IE9TUyBmcm9tIFwiYWxpLW9zc1wiO1xuaW1wb3J0IGZzIGZyb20gXCJmcy1leHRyYVwiO1xuaW1wb3J0IHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCB7IEJ1aWxkTG9nZ2VyIH0gZnJvbSBcIi4uLy4uL2J1aWxkZXIvQnVpbGRMb2dnZXJcIjtcbmltcG9ydCB7IENvbnN0YW50IH0gZnJvbSBcIi4uLy4uL3Rvb2xzL0NvbnN0YW50XCI7XG5pbXBvcnQgeyBVdGlscyB9IGZyb20gXCIuLi8uLi90b29scy9VdGlsc1wiO1xuXG4vKiog5LiK5Lyg5paH5Lu25pe2IOWcqOWFg+aVsOaNruS/neeVmeacgOWQjuS/ruaUueaXtumXtCDmlrnkvr/kuIrkvKDml7bmr5TovoMgKi9cbmNvbnN0IG1UaW1lS2V5ID0gXCJ4LW9zcy1tZXRhLWxhc3QtbW9kaWZpZWRcIjtcblxuY29uc3QgdGFnID0gXCJbQWxpT1NTXVwiO1xuXG4vKiog5LiK5Lyg5bm25Y+R5pWw6YePICovXG5jb25zdCBjb25jdXJyZW50ID0gMTA7XG5cbi8qKiDmlofku7bkuIrkvKDlpLHotKXph43or5XmrKHmlbAgKi9cbmNvbnN0IHJldHJ5ID0gMztcblxubGV0IGVuZFJlc29sdmU6IEZ1bmN0aW9uO1xuXG5cbi8qKiDpmL/ph4zkupFvc3PkuIrkvKDlt6XlhbcgKi9cbmV4cG9ydCBjbGFzcyBBbGlPU1Mge1xuXG4gICAgLyoqIE9TU+WuouaIt+erryAqL1xuICAgIHByaXZhdGUgY2xpZW50OiBPU1MgPSBudWxsO1xuXG4gICAgcHJpdmF0ZSBsb2NhbERpcjogc3RyaW5nID0gXCJcIjtcbiAgICBwcml2YXRlIG9zc0Rpcjogc3RyaW5nID0gXCJcIjtcblxuICAgIC8qKiDliankvZnmlofku7YgKi9cbiAgICBwcml2YXRlIHJlbWFpbkZpbGVzOiBzdHJpbmdbXTtcblxuICAgIC8qKiDmlofku7bph43or5XmrKHmlbAgKi9cbiAgICBwcml2YXRlIHJldHJ5Q250OiBNYXA8c3RyaW5nLCBudW1iZXI+ID0gbmV3IE1hcCgpO1xuXG5cblxuICAgIHByaXZhdGUgc3RhcnRUaW1lTVMgPSAwO1xuICAgIHByaXZhdGUgdG90YWxDbnQgPSAwOy8v5oC75YWx5pWw6YePXG4gICAgcHJpdmF0ZSBzdWNjQ250ID0gMDsvL+aIkOWKn+aVsOmHj1xuICAgIHByaXZhdGUgZmFpbENudCA9IDA7Ly/lpLHotKXmlbDph49cbiAgICBwcml2YXRlIHNraXBDbnQgPSAwOy8v6Lez6L+H5pWw6YePXG5cbiAgICAvKipcbiAgICAgKiDkuIrkvKDmnKzlnLDotYTmupDnm67lvZXliLBvc3PmjIflrprnm67lvZVcbiAgICAgKiBAcGFyYW0gbG9jYWxEaXIg5pys5Zyw6LWE5rqQ55uu5b2V5Zyw5Z2AXG4gICAgICogQHBhcmFtIG9zc0RpciBPU1Pnm67lvZXlnLDlnYAg5L6L77ya6ZyA6KaB5LiK5Lyg5YiwKG9zczovL2J1Y2tldE5hbWUvVGVzdC8pIOatpOaXtuW6lOivpeWhqyhUZXN0Lykg5LiN6ZyA6KaB5YyF5ZCr5YmN6Z2i55qE6YOo5YiGXG4gICAgICovXG4gICAgY29uc3RydWN0b3IobG9jYWxEaXI6IHN0cmluZywgb3NzRGlyOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5sb2NhbERpciA9IFV0aWxzLnRvVW5pU2VwYXJhdG9yKGxvY2FsRGlyKTtcbiAgICAgICAgdGhpcy5vc3NEaXIgPSBvc3NEaXI7XG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKiDkuIrkvKDotYTmupBcbiAgICAgKiBAcGFyYW0gdGFza05hbWUg5p6E5bu65Lu75Yqh5ZCN5a2XKOWPr+iDveS4jeWQjOeahOaehOW7uuS7u+WKoemcgOimgeS4iuS8oOWIsOS4jeWQjOeahE9TUylcbiAgICAgKiBAcGFyYW0gZmlsZXMg6ZyA6KaB5LiK5Lyg55qE5paH5Lu2XG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIHVwbG9hZCh0YXNrTmFtZTogc3RyaW5nLCBmaWxlczogc3RyaW5nW10pIHtcbiAgICAgICAgaWYgKCF0aGlzLmxvY2FsRGlyKSB7XG4gICAgICAgICAgICBCdWlsZExvZ2dlci5lcnJvcih0YWcsIFwi5pys5Zyw6LWE5rqQ55uu5b2V5Li656m6XCIpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy5vc3NEaXIpIHtcbiAgICAgICAgICAgIEJ1aWxkTG9nZ2VyLmVycm9yKHRhZywgXCJPU1Pnm67lvZXkuLrnqbpcIik7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcCA9IG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGxldCBjb25maWdQYXRoID0gQ29uc3RhbnQuQWxpT1NTQ29uZmlnRmlsZVBhdGgucmVwbGFjZShcIi5qc29uXCIsIFwiX1wiICsgdGFza05hbWUgKyBcIi5qc29uXCIpO1xuICAgICAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKGNvbmZpZ1BhdGgpKSB7XG4gICAgICAgICAgICAgICAgY29uZmlnUGF0aCA9IENvbnN0YW50LkFsaU9TU0NvbmZpZ0ZpbGVQYXRoO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKGNvbmZpZ1BhdGgpKSB7XG4gICAgICAgICAgICAgICAgQnVpbGRMb2dnZXIuaW5mbyh0YWcsIFwiYWxpX29zc19jb25maWcuanNvbuaWh+S7tuS4jeWtmOWcqCzot7Pov4fkuIrkvKBcIik7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBsZXQgY29uZmlnID0gZnMucmVhZEpTT05TeW5jKGNvbmZpZ1BhdGgpO1xuICAgICAgICAgICAgICAgIGxldCBvc3NEaXJQcmVmaXggPSBjb25maWdbJ29zc0RpclByZWZpeCddO1xuICAgICAgICAgICAgICAgIGlmIChvc3NEaXJQcmVmaXgpIHRoaXMub3NzRGlyID0gVXRpbHMudG9VbmlTZXBhcmF0b3IocGF0aC5qb2luKG9zc0RpclByZWZpeCwgdGhpcy5vc3NEaXIpKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNsaWVudCA9IG5ldyBPU1MoY29uZmlnKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBCdWlsZExvZ2dlci5lcnJvcihlKTtcbiAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBCdWlsZExvZ2dlci5pbmZvKHRhZywgYExvY2FsRGlyPSR7dGhpcy5sb2NhbERpcn0gT1NTRGlyPSR7dGhpcy5vc3NEaXJ9YCk7XG4gICAgICAgICAgICB0aGlzLnJlbWFpbkZpbGVzID0gZmlsZXM7XG5cbiAgICAgICAgICAgIHRoaXMudG90YWxDbnQgPSB0aGlzLnJlbWFpbkZpbGVzLmxlbmd0aDtcbiAgICAgICAgICAgIHRoaXMuc3RhcnRUaW1lTVMgPSBEYXRlLm5vdygpO1xuXG4gICAgICAgICAgICBCdWlsZExvZ2dlci5pbmZvKHRhZywgYOato+WcqOS4iuS8oOS4rSDor7fogJDlv4PnrYnlvoUg5paH5Lu25pWw6YePOiR7dGhpcy50b3RhbENudH1gKTtcblxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb25jdXJyZW50OyBpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5yZW1haW5GaWxlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkRmlsZSh0aGlzLnJlbWFpbkZpbGVzLnBvcCgpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGVuZFJlc29sdmUgPSByZXNvbHZlO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGxvY2FsVG9Pc3NQYXRoKGZpbGU6IHN0cmluZykge1xuICAgICAgICBsZXQgZGlyTmFtZSA9IHBhdGguYmFzZW5hbWUodGhpcy5sb2NhbERpcik7XG4gICAgICAgIGxldCBzdWZmaXggPSBmaWxlLnJlcGxhY2UodGhpcy5sb2NhbERpciwgZGlyTmFtZSk7XG4gICAgICAgIGxldCByZW1vdGVQYXRoID0gVXRpbHMudG9VbmlTZXBhcmF0b3IocGF0aC5qb2luKHRoaXMub3NzRGlyLCBzdWZmaXgpKTtcbiAgICAgICAgcmV0dXJuIHJlbW90ZVBhdGg7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyB1cGxvYWRGaWxlKGxvY2FsUGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGxldCByZW1vdGVQYXRoID0gdGhpcy5sb2NhbFRvT3NzUGF0aChsb2NhbFBhdGgpO1xuICAgICAgICBjb25zdCBzdGF0ID0gZnMuc3RhdFN5bmMobG9jYWxQYXRoKTtcbiAgICAgICAgY29uc3QgbVRpbWVNUyA9IHN0YXQubXRpbWUuZ2V0VGltZSgpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5jbGllbnQuaGVhZChyZW1vdGVQYXRoKTtcbiAgICAgICAgICAgIGxldCB0aW1lTVM6IG51bWJlciA9IHJlc3VsdC5yZXMuaGVhZGVyc1ttVGltZUtleV07XG4gICAgICAgICAgICBsZXQgc2l6ZTogbnVtYmVyID0gcmVzdWx0LnJlcy5oZWFkZXJzW1wiY29udGVudC1sZW5ndGhcIl07XG4gICAgICAgICAgICBpZiAoc2l6ZSA9PSBzdGF0LnNpemUgJiYgdGltZU1TID09IG1UaW1lTVMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnVwbG9hZEVuZGVkKGxvY2FsUGF0aCwgMik7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlKSB7IH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgaGVhZGVycyA9IHsgW21UaW1lS2V5XTogbVRpbWVNUyB9XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmNsaWVudC5wdXQocmVtb3RlUGF0aCwgbG9jYWxQYXRoLCB7IGhlYWRlcnM6IGhlYWRlcnMgfSk7XG4gICAgICAgICAgICB0aGlzLnVwbG9hZEVuZGVkKGxvY2FsUGF0aCwgMSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgdGhpcy51cGxvYWRFbmRlZChsb2NhbFBhdGgsIDAsIGVycik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHBlcmNlbnQgPSAwLjE7XG4gICAgcHJpdmF0ZSB1cGxvYWRFbmRlZChmaWxlOiBzdHJpbmcsIGNvZGU6IG51bWJlciwgZXJyPzogRXJyb3IpIHtcbiAgICAgICAgaWYgKGNvZGUgPT0gMCkgey8v5aSx6LSl6YeN6K+V5qOA5rWLXG4gICAgICAgICAgICBsZXQgcmUgPSB0aGlzLnJldHJ5Q250LmhhcyhmaWxlKSA/IHRoaXMucmV0cnlDbnQuZ2V0KGZpbGUpIDogcmV0cnk7XG4gICAgICAgICAgICBpZiAocmUgPiAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy51cGxvYWRGaWxlKGZpbGUpO1xuICAgICAgICAgICAgICAgIHRoaXMucmV0cnlDbnQuc2V0KGZpbGUsIHJlIC0gMSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKHRhZywgYOS4iuS8oOWksei0pSAke2ZpbGV9IGAsIGVyci5tZXNzYWdlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb2RlID09IDEpIHRoaXMuc3VjY0NudCArPSAxO1xuICAgICAgICBlbHNlIGlmIChjb2RlID09IDIpIHRoaXMuc2tpcENudCArPSAxO1xuICAgICAgICBlbHNlIHRoaXMuZmFpbENudCArPSAxO1xuXG4gICAgICAgIHRoaXMuY2hlY2tDb21wbGV0ZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2hlY2tDb21wbGV0ZSgpIHtcbiAgICAgICAgbGV0IGNvbXBsZXRlID0gdGhpcy5zdWNjQ250ICsgdGhpcy5mYWlsQ250ICsgdGhpcy5za2lwQ250O1xuXG4gICAgICAgIGlmIChjb21wbGV0ZSA9PSBNYXRoLmZsb29yKHRoaXMudG90YWxDbnQgKiB0aGlzLnBlcmNlbnQpKSB7Ly/ovr7liLDmn5DkuKrov5vluqbml7bmiZPljbBcbiAgICAgICAgICAgIEJ1aWxkTG9nZ2VyLmluZm8odGFnLCBg5LiK5Lyg6L+b5bqmOiR7TWF0aC5yb3VuZCh0aGlzLnBlcmNlbnQgKiAxMDApfSVgKTtcbiAgICAgICAgICAgIHRoaXMucGVyY2VudCArPSAwLjE7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29tcGxldGUgIT0gdGhpcy50b3RhbENudCkgey8v5pyq5LiK5Lyg5a6M5oiQXG4gICAgICAgICAgICBpZiAodGhpcy5yZW1haW5GaWxlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy51cGxvYWRGaWxlKHRoaXMucmVtYWluRmlsZXMucG9wKCkpOy8v57un57ut5LiK5LygXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAvL+WFqOmDqOS4iuS8oOWujOaIkFxuICAgICAgICBsZXQgZHRUaW1lTVMgPSBNYXRoLmZsb29yKChEYXRlLm5vdygpIC0gdGhpcy5zdGFydFRpbWVNUykgLyAxMDAwKTtcbiAgICAgICAgaWYgKHRoaXMuZmFpbENudCA+IDApIHtcbiAgICAgICAgICAgIEJ1aWxkTG9nZ2VyLmVycm9yKHRhZywgYOS4iuS8oOWksei0pSDmgLvlhbE6JHt0aGlzLnRvdGFsQ250fSDlpLHotKU6JHt0aGlzLmZhaWxDbnR9IOiAl+aXtjoke2R0VGltZU1TfeenkmApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgQnVpbGRMb2dnZXIuaW5mbyh0YWcsIGDkuIrkvKDmiJDlip8g5oC75YWxOiR7dGhpcy50b3RhbENudH0g5LiK5LygOiR7dGhpcy5zdWNjQ250fSDot7Pov4c6JHt0aGlzLnNraXBDbnR9IOiAl+aXtjoke2R0VGltZU1TfeenkmApO1xuICAgICAgICB9XG4gICAgICAgIGVuZFJlc29sdmUoKTtcbiAgICB9XG5cbn1cbiJdfQ==