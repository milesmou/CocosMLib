"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.CmdExecute = void 0;
const fs_extra_1 = __importDefault(require("fs-extra"));
const path_1 = __importDefault(require("path"));
const Config_1 = require("./tools/Config");
const Logger_1 = require("./tools/Logger");
const Utils_1 = require("./tools/Utils");
class CmdExecute {
    /** 功能测试 */
    static async test(...args) {
        // console.log("test",args.join(" "));
        let v = await Editor.Dialog.info(`是否上传文件到OSS?`, {
            title: "上传远程资源",
            detail: "[上传远程资源]",
            default: 2,
            buttons: ['取消', '取消1', '确认',]
        });
        console.log(v);
    }
    /** 发送消息 */
    static sendMessage(jsonStr) {
        try {
            let { key, args } = JSON.parse(jsonStr);
        }
        catch (error) {
            Logger_1.Logger.error("发送消息失败", error);
        }
    }
    /** 保存游戏配置到本地 */
    static saveGameSetting(jsonStr) {
        Config_1.Config.set("gameSetting", JSON.parse(jsonStr));
    }
    /** 保存文件 */
    static saveFile(jsonStr) {
        try {
            let { filePath, content, refreshAsset = false, succLog = true } = JSON.parse(jsonStr);
            let fullPath = Utils_1.Utils.toUniSeparator(path_1.default.join(Utils_1.Utils.ProjectPath, filePath));
            fs_extra_1.default.ensureDirSync(path_1.default.dirname(fullPath));
            fs_extra_1.default.writeFileSync(fullPath, content);
            if (refreshAsset) {
                Utils_1.Utils.refreshAsset(fullPath);
            }
            if (succLog)
                Logger_1.Logger.info("保存文件成功", fullPath);
        }
        catch (error) {
            Logger_1.Logger.error("保存文件失败", error);
            return;
        }
    }
    /**
     * 删除文件
     * @param filePath 相对项目路径的文件路径
     */
    static deleteFile(jsonStr) {
        try {
            let { filePath, refreshAsset = false, succLog = true } = JSON.parse(jsonStr);
            let fullPath = Utils_1.Utils.toUniSeparator(path_1.default.join(Utils_1.Utils.ProjectPath, filePath));
            if (!fs_extra_1.default.existsSync(fullPath)) {
                Logger_1.Logger.warn("文件不存在", fullPath);
                return;
            }
            fs_extra_1.default.removeSync(fullPath);
            if (refreshAsset) {
                Utils_1.Utils.refreshAsset(fullPath);
            }
            if (succLog)
                Logger_1.Logger.info("删除文件成功", fullPath);
        }
        catch (error) {
            Logger_1.Logger.error("删除文件失败", error);
            return;
        }
    }
    /** 导表 */
    static loadExcel() {
        let workDir = Utils_1.Utils.ProjectPath + "/excel";
        let batPath = "gen_code.bat";
        let tsDir = Utils_1.Utils.ProjectPath + "/assets/scripts/gen/table";
        fs_extra_1.default.ensureDirSync(tsDir);
        Logger_1.Logger.info(workDir);
        Utils_1.Utils.exeCMD(workDir, batPath, msg => {
            Logger_1.Logger.info(msg);
        }).then(code => {
            if (!code) {
                let path1 = Utils_1.Utils.ProjectPath + "/assets/bundles";
                let path2 = Utils_1.Utils.ProjectPath + "/assets/resources";
                let filter = dir => dir.endsWith("/table");
                let dirs = Utils_1.Utils.getAllDirs(path1, filter).concat(Utils_1.Utils.getAllDirs(path2, filter));
                for (const dir of dirs) {
                    Utils_1.Utils.refreshAsset(dir);
                }
                Utils_1.Utils.refreshAsset(tsDir);
            }
            else {
                Logger_1.Logger.error("导表失败");
            }
        });
    }
    /** 生成一些常量 */
    static genConst() {
        //生成UIConstant
        {
            let map = {};
            let outFile = Utils_1.Utils.ProjectPath + "/assets/scripts/gen/UIConstant.ts";
            let ext = ".prefab";
            let path1 = Utils_1.Utils.ProjectPath + "/assets/bundles";
            let path2 = Utils_1.Utils.ProjectPath + "/assets/resources";
            let filter = (file) => file.endsWith(ext);
            let files = Utils_1.Utils.getAllFiles(path1, filter).concat(Utils_1.Utils.getAllFiles(path2, filter));
            files.forEach(v => {
                let basename = path_1.default.basename(v);
                let index = v.indexOf("/uiPrefab/");
                if (index > 0) {
                    let name = basename.replace(ext, "");
                    let location = v.substring(index + 1);
                    location = location.replace(ext, "");
                    map[name] = location;
                }
            });
            let content = "export const UIConstant = {\n";
            for (const key in map) {
                content += `    ${key}: "${map[key]}",\n`;
            }
            content += "} as const;";
            fs_extra_1.default.ensureDirSync(path_1.default.dirname(outFile));
            fs_extra_1.default.writeFileSync(outFile, content);
            Utils_1.Utils.refreshAsset(outFile);
            Logger_1.Logger.info("生成UIConstant成功");
        }
    }
    static closeTexCompress() {
        Logger_1.Logger.info("关闭纹理压缩开始");
        let exts = [".jpg", ".png", ".jpeg", ".pac"];
        let filter = (file) => {
            let ext = path_1.default.extname(file);
            return exts.includes(ext);
        };
        let allFiles = Utils_1.Utils.getAllFiles(Utils_1.Utils.ProjectPath + "/assets", filter);
        for (const file of allFiles) {
            if (path_1.default.basename(file).startsWith("__"))
                continue;
            let metaFile = file + ".meta";
            let obj = fs_extra_1.default.readJSONSync(metaFile);
            let compressSettings = obj.userData.compressSettings;
            if (compressSettings && compressSettings.useCompressTexture) {
                compressSettings.useCompressTexture = false;
                fs_extra_1.default.writeJSONSync(metaFile, obj, { spaces: 2 });
                Utils_1.Utils.refreshAsset(file);
                Logger_1.Logger.info("关闭纹理压缩", file);
            }
        }
        Logger_1.Logger.info("关闭纹理压缩结束");
    }
    static setTexCompress() {
        let presetId = Editor.Clipboard.read("text");
        if (presetId.length != 22) {
            Logger_1.Logger.warn("请先拷贝一个纹理压缩配置的22位UUID到剪切板(项目设置-压缩纹理-配置压缩预设集)");
        }
        else {
            Logger_1.Logger.info("纹理压缩方案UUID:", presetId);
            let exts = [".jpg", ".png", ".jpeg", ".pac"];
            let filter = (file) => {
                let ext = path_1.default.extname(file);
                return exts.includes(ext);
            };
            let allFiles = Utils_1.Utils.getAllFiles(Utils_1.Utils.ProjectPath + "/assets", filter);
            for (const file of allFiles) {
                if (path_1.default.basename(file).startsWith("__"))
                    continue;
                let metaFile = file + ".meta";
                let obj = fs_extra_1.default.readJSONSync(metaFile);
                let compressSettings = obj.userData.compressSettings;
                if (!compressSettings || !compressSettings.useCompressTexture || compressSettings.presetId != presetId) {
                    let newCompressSettings = {
                        useCompressTexture: true,
                        presetId: presetId
                    };
                    obj.userData.compressSettings = newCompressSettings;
                    fs_extra_1.default.writeJSONSync(metaFile, obj, { spaces: 2 });
                    Utils_1.Utils.refreshAsset(file);
                    Logger_1.Logger.info(`纹理压缩设置  ${file}`);
                }
            }
            Logger_1.Logger.info("设置纹理压缩结束");
        }
    }
    //切换配置开关
    static setSwitch(key, desc) {
        let value = !Config_1.Config.get(key, false);
        Config_1.Config.set(key, value);
        console.log(`${desc || key}: ${value ? "开" : "关"}`);
    }
}
exports.CmdExecute = CmdExecute;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ21kRXhlY3V0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NvdXJjZS9DbWRFeGVjdXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLHdEQUEwQjtBQUMxQixnREFBd0I7QUFDeEIsMkNBQXdDO0FBQ3hDLDJDQUF3QztBQUN4Qyx5Q0FBc0M7QUFFdEMsTUFBYSxVQUFVO0lBRW5CLFdBQVc7SUFDSixNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLElBQVc7UUFDbkMsc0NBQXNDO1FBQ3RDLElBQUksQ0FBQyxHQUFHLE1BQU0sTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQzVDLEtBQUssRUFBRSxRQUFRO1lBQ2YsTUFBTSxFQUFFLFVBQVU7WUFDbEIsT0FBTyxFQUFFLENBQUM7WUFDVixPQUFPLEVBQUUsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRTtTQUNoQyxDQUFDLENBQUE7UUFDRixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ25CLENBQUM7SUFHRCxXQUFXO0lBQ0osTUFBTSxDQUFDLFdBQVcsQ0FBQyxPQUFlO1FBT3JDLElBQUk7WUFDQSxJQUFJLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFZLENBQUM7U0FFdEQ7UUFBQyxPQUFPLEtBQUssRUFBRTtZQUNaLGVBQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ2pDO0lBQ0wsQ0FBQztJQUVELGdCQUFnQjtJQUNULE1BQU0sQ0FBQyxlQUFlLENBQUMsT0FBZTtRQUN6QyxlQUFNLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQUVELFdBQVc7SUFDSixNQUFNLENBQUMsUUFBUSxDQUFDLE9BQWU7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Q3pFLGtCQUFrQixFQUFFLElBQUk7d0JBQ3hCLFFBQVEsRUFBRSxRQUFRO3FCQUNyQixDQUFBO29CQUNELEdBQUcsQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLEdBQUcsbUJBQW1CLENBQUM7b0JBQ3BELGtCQUFFLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztvQkFDL0MsYUFBSyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDekIsZUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLElBQUksRUFBRSxDQUFDLENBQUM7aUJBQ2xDO2FBQ0o7WUFDRCxlQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQzNCO0lBQ0wsQ0FBQztJQUVELFFBQVE7SUFDRCxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQVcsRUFBRSxJQUFZO1FBQzdDLElBQUksS0FBSyxHQUFHLENBQUMsZUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDcEMsZUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFDdEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksSUFBSSxHQUFHLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDeEQsQ0FBQztDQUdKO0FBOU5ELGdDQThOQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tIFwiZnMtZXh0cmFcIjtcclxuaW1wb3J0IHBhdGggZnJvbSBcInBhdGhcIjtcclxuaW1wb3J0IHsgQ29uZmlnIH0gZnJvbSBcIi4vdG9vbHMvQ29uZmlnXCI7XHJcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gXCIuL3Rvb2xzL0xvZ2dlclwiO1xyXG5pbXBvcnQgeyBVdGlscyB9IGZyb20gXCIuL3Rvb2xzL1V0aWxzXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgQ21kRXhlY3V0ZSB7XHJcblxyXG4gICAgLyoqIOWKn+iDvea1i+ivlSAqL1xyXG4gICAgcHVibGljIHN0YXRpYyBhc3luYyB0ZXN0KC4uLmFyZ3M6IGFueVtdKSB7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJ0ZXN0XCIsYXJncy5qb2luKFwiIFwiKSk7XHJcbiAgICAgICAgbGV0IHYgPSBhd2FpdCBFZGl0b3IuRGlhbG9nLmluZm8oYOaYr+WQpuS4iuS8oOaWh+S7tuWIsE9TUz9gLCB7XHJcbiAgICAgICAgICAgIHRpdGxlOiBcIuS4iuS8oOi/nOeoi+i1hOa6kFwiLFxyXG4gICAgICAgICAgICBkZXRhaWw6IFwiW+S4iuS8oOi/nOeoi+i1hOa6kF1cIixcclxuICAgICAgICAgICAgZGVmYXVsdDogMixcclxuICAgICAgICAgICAgYnV0dG9uczogWyflj5bmtognLCAn5Y+W5raIMScsICfnoa7orqQnLF1cclxuICAgICAgICB9KVxyXG4gICAgICAgIGNvbnNvbGUubG9nKHYpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICAvKiog5Y+R6YCB5raI5oGvICovXHJcbiAgICBwdWJsaWMgc3RhdGljIHNlbmRNZXNzYWdlKGpzb25TdHI6IHN0cmluZykge1xyXG4gICAgICAgIGludGVyZmFjZSBNZXNzYWdlIHtcclxuICAgICAgICAgICAgLyoqIOa2iOaBr+WQjeensCAqL1xyXG4gICAgICAgICAgICBrZXk6IHN0cmluZyxcclxuICAgICAgICAgICAgLyoqIOa2iOaBr+WPguaVsCAqL1xyXG4gICAgICAgICAgICBhcmdzOiBhbnlbXSxcclxuICAgICAgICB9XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgbGV0IHsga2V5LCBhcmdzIH0gPSBKU09OLnBhcnNlKGpzb25TdHIpIGFzIE1lc3NhZ2U7XHJcblxyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIExvZ2dlci5lcnJvcihcIuWPkemAgea2iOaBr+Wksei0pVwiLCBlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKiDkv53lrZjmuLjmiI/phY3nva7liLDmnKzlnLAgKi9cclxuICAgIHB1YmxpYyBzdGF0aWMgc2F2ZUdhbWVTZXR0aW5nKGpzb25TdHI6IHN0cmluZykge1xyXG4gICAgICAgIENvbmZpZy5zZXQoXCJnYW1lU2V0dGluZ1wiLCBKU09OLnBhcnNlKGpzb25TdHIpKTtcclxuICAgIH1cclxuXHJcbiAgICAvKiog5L+d5a2Y5paH5Lu2ICovXHJcbiAgICBwdWJsaWMgc3RhdGljIHNhdmVGaWxlKGpzb25TdHI6IHN0cmluZykge1xyXG4gICAgICAgIGludGVyZmFjZSBTYXZlRmlsZVBhcmFtcyB7XHJcbiAgICAgICAgICAgIC8qKiDnm7jlr7npobnnm67ot6/lvoTnmoTmlofku7bot6/lvoQgKi9cclxuICAgICAgICAgICAgZmlsZVBhdGg6IHN0cmluZyxcclxuICAgICAgICAgICAgLyoqIOaWh+S7tuWGheWuuSAqL1xyXG4gICAgICAgICAgICBjb250ZW50OiBzdHJpbmcsXHJcbiAgICAgICAgICAgIC8qKiDmmK/lkKbliLfmlrDotYTmupAgKi9cclxuICAgICAgICAgICAgcmVmcmVzaEFzc2V0OiBib29sZWFuLFxyXG4gICAgICAgICAgICAvKiog5piv5ZCm5omT5Y2w5oiQ5Yqf5pel5b+XICovXHJcbiAgICAgICAgICAgIHN1Y2NMb2c/OiBib29sZWFuLFxyXG4gICAgICAgIH1cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBsZXQgeyBmaWxlUGF0aCwgY29udGVudCwgcmVmcmVzaEFzc2V0ID0gZmFsc2UsIHN1Y2NMb2cgPSB0cnVlIH0gPSBKU09OLnBhcnNlKGpzb25TdHIpIGFzIFNhdmVGaWxlUGFyYW1zO1xyXG4gICAgICAgICAgICBsZXQgZnVsbFBhdGggPSBVdGlscy50b1VuaVNlcGFyYXRvcihwYXRoLmpvaW4oVXRpbHMuUHJvamVjdFBhdGgsIGZpbGVQYXRoKSk7XHJcbiAgICAgICAgICAgIGZzLmVuc3VyZURpclN5bmMocGF0aC5kaXJuYW1lKGZ1bGxQYXRoKSk7XHJcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZnVsbFBhdGgsIGNvbnRlbnQpO1xyXG4gICAgICAgICAgICBpZiAocmVmcmVzaEFzc2V0KSB7XHJcbiAgICAgICAgICAgICAgICBVdGlscy5yZWZyZXNoQXNzZXQoZnVsbFBhdGgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChzdWNjTG9nKSBMb2dnZXIuaW5mbyhcIuS/neWtmOaWh+S7tuaIkOWKn1wiLCBmdWxsUGF0aCk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICAgICAgTG9nZ2VyLmVycm9yKFwi5L+d5a2Y5paH5Lu25aSx6LSlXCIsIGVycm9yKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKiogXHJcbiAgICAgKiDliKDpmaTmlofku7ZcclxuICAgICAqIEBwYXJhbSBmaWxlUGF0aCDnm7jlr7npobnnm67ot6/lvoTnmoTmlofku7bot6/lvoRcclxuICAgICAqL1xyXG4gICAgcHVibGljIHN0YXRpYyBkZWxldGVGaWxlKGpzb25TdHI6IHN0cmluZykge1xyXG4gICAgICAgIGludGVyZmFjZSBEZWxldGVGaWxlUGFyYW1zIHtcclxuICAgICAgICAgICAgLyoqIOebuOWvuemhueebrui3r+W+hOeahOaWh+S7tui3r+W+hCAqL1xyXG4gICAgICAgICAgICBmaWxlUGF0aDogc3RyaW5nLFxyXG4gICAgICAgICAgICAvKiog5piv5ZCm5Yi35paw6LWE5rqQICovXHJcbiAgICAgICAgICAgIHJlZnJlc2hBc3NldD86IGJvb2xlYW4sXHJcbiAgICAgICAgICAgIC8qKiDmmK/lkKbmiZPljbDmiJDlip/ml6Xlv5cgKi9cclxuICAgICAgICAgICAgc3VjY0xvZz86IGJvb2xlYW4sXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGxldCB7IGZpbGVQYXRoLCByZWZyZXNoQXNzZXQgPSBmYWxzZSwgc3VjY0xvZyA9IHRydWUgfSA9IEpTT04ucGFyc2UoanNvblN0cikgYXMgRGVsZXRlRmlsZVBhcmFtcztcclxuICAgICAgICAgICAgbGV0IGZ1bGxQYXRoID0gVXRpbHMudG9VbmlTZXBhcmF0b3IocGF0aC5qb2luKFV0aWxzLlByb2plY3RQYXRoLCBmaWxlUGF0aCkpO1xyXG4gICAgICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZnVsbFBhdGgpKSB7XHJcbiAgICAgICAgICAgICAgICBMb2dnZXIud2FybihcIuaWh+S7tuS4jeWtmOWcqFwiLCBmdWxsUGF0aCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZnMucmVtb3ZlU3luYyhmdWxsUGF0aCk7XHJcbiAgICAgICAgICAgIGlmIChyZWZyZXNoQXNzZXQpIHtcclxuICAgICAgICAgICAgICAgIFV0aWxzLnJlZnJlc2hBc3NldChmdWxsUGF0aCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHN1Y2NMb2cpIExvZ2dlci5pbmZvKFwi5Yig6Zmk5paH5Lu25oiQ5YqfXCIsIGZ1bGxQYXRoKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICBMb2dnZXIuZXJyb3IoXCLliKDpmaTmlofku7blpLHotKVcIiwgZXJyb3IpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKiDlr7zooaggKi9cclxuICAgIHB1YmxpYyBzdGF0aWMgbG9hZEV4Y2VsKCkge1xyXG4gICAgICAgIGxldCB3b3JrRGlyID0gVXRpbHMuUHJvamVjdFBhdGggKyBcIi9leGNlbFwiO1xyXG4gICAgICAgIGxldCBiYXRQYXRoID0gXCJnZW5fY29kZS5iYXRcIjtcclxuICAgICAgICBsZXQgdHNEaXIgPSBVdGlscy5Qcm9qZWN0UGF0aCArIFwiL2Fzc2V0cy9zY3JpcHRzL2dlbi90YWJsZVwiO1xyXG4gICAgICAgIGZzLmVuc3VyZURpclN5bmModHNEaXIpO1xyXG4gICAgICAgIExvZ2dlci5pbmZvKHdvcmtEaXIpXHJcbiAgICAgICAgVXRpbHMuZXhlQ01EKHdvcmtEaXIsIGJhdFBhdGgsXHJcbiAgICAgICAgICAgIG1zZyA9PiB7XHJcbiAgICAgICAgICAgICAgICBMb2dnZXIuaW5mbyhtc2cpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgKS50aGVuKGNvZGUgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIWNvZGUpIHtcclxuICAgICAgICAgICAgICAgIGxldCBwYXRoMSA9IFV0aWxzLlByb2plY3RQYXRoICsgXCIvYXNzZXRzL2J1bmRsZXNcIjtcclxuICAgICAgICAgICAgICAgIGxldCBwYXRoMiA9IFV0aWxzLlByb2plY3RQYXRoICsgXCIvYXNzZXRzL3Jlc291cmNlc1wiO1xyXG4gICAgICAgICAgICAgICAgbGV0IGZpbHRlciA9IGRpciA9PiBkaXIuZW5kc1dpdGgoXCIvdGFibGVcIik7XHJcbiAgICAgICAgICAgICAgICBsZXQgZGlycyA9IFV0aWxzLmdldEFsbERpcnMocGF0aDEsIGZpbHRlcikuY29uY2F0KFV0aWxzLmdldEFsbERpcnMocGF0aDIsIGZpbHRlcikpO1xyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBkaXIgb2YgZGlycykge1xyXG4gICAgICAgICAgICAgICAgICAgIFV0aWxzLnJlZnJlc2hBc3NldChkaXIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgVXRpbHMucmVmcmVzaEFzc2V0KHRzRGlyKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIExvZ2dlci5lcnJvcihcIuWvvOihqOWksei0pVwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKiDnlJ/miJDkuIDkupvluLjph48gKi9cclxuICAgIHB1YmxpYyBzdGF0aWMgZ2VuQ29uc3QoKSB7XHJcbiAgICAgICAgLy/nlJ/miJBVSUNvbnN0YW50XHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBsZXQgbWFwID0ge307XHJcbiAgICAgICAgICAgIGxldCBvdXRGaWxlID0gVXRpbHMuUHJvamVjdFBhdGggKyBcIi9hc3NldHMvc2NyaXB0cy9nZW4vVUlDb25zdGFudC50c1wiO1xyXG4gICAgICAgICAgICBsZXQgZXh0ID0gXCIucHJlZmFiXCI7XHJcblxyXG4gICAgICAgICAgICBsZXQgcGF0aDEgPSBVdGlscy5Qcm9qZWN0UGF0aCArIFwiL2Fzc2V0cy9idW5kbGVzXCI7XHJcbiAgICAgICAgICAgIGxldCBwYXRoMiA9IFV0aWxzLlByb2plY3RQYXRoICsgXCIvYXNzZXRzL3Jlc291cmNlc1wiO1xyXG4gICAgICAgICAgICBsZXQgZmlsdGVyID0gKGZpbGU6IHN0cmluZykgPT4gZmlsZS5lbmRzV2l0aChleHQpO1xyXG4gICAgICAgICAgICBsZXQgZmlsZXMgPSBVdGlscy5nZXRBbGxGaWxlcyhwYXRoMSwgZmlsdGVyKS5jb25jYXQoVXRpbHMuZ2V0QWxsRmlsZXMocGF0aDIsIGZpbHRlcikpO1xyXG4gICAgICAgICAgICBmaWxlcy5mb3JFYWNoKHYgPT4ge1xyXG4gICAgICAgICAgICAgICAgbGV0IGJhc2VuYW1lID0gcGF0aC5iYXNlbmFtZSh2KTtcclxuICAgICAgICAgICAgICAgIGxldCBpbmRleCA9IHYuaW5kZXhPZihcIi91aVByZWZhYi9cIik7XHJcbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IG5hbWUgPSBiYXNlbmFtZS5yZXBsYWNlKGV4dCwgXCJcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGxvY2F0aW9uID0gdi5zdWJzdHJpbmcoaW5kZXggKyAxKTtcclxuICAgICAgICAgICAgICAgICAgICBsb2NhdGlvbiA9IGxvY2F0aW9uLnJlcGxhY2UoZXh0LCBcIlwiKTtcclxuICAgICAgICAgICAgICAgICAgICBtYXBbbmFtZV0gPSBsb2NhdGlvbjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBsZXQgY29udGVudCA9IFwiZXhwb3J0IGNvbnN0IFVJQ29uc3RhbnQgPSB7XFxuXCI7XHJcbiAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIG1hcCkge1xyXG4gICAgICAgICAgICAgICAgY29udGVudCArPSBgICAgICR7a2V5fTogXCIke21hcFtrZXldfVwiLFxcbmA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29udGVudCArPSBcIn0gYXMgY29uc3Q7XCI7XHJcblxyXG4gICAgICAgICAgICBmcy5lbnN1cmVEaXJTeW5jKHBhdGguZGlybmFtZShvdXRGaWxlKSk7XHJcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMob3V0RmlsZSwgY29udGVudCk7XHJcbiAgICAgICAgICAgIFV0aWxzLnJlZnJlc2hBc3NldChvdXRGaWxlKTtcclxuICAgICAgICAgICAgTG9nZ2VyLmluZm8oXCLnlJ/miJBVSUNvbnN0YW505oiQ5YqfXCIpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBjbG9zZVRleENvbXByZXNzKCkge1xyXG4gICAgICAgIExvZ2dlci5pbmZvKFwi5YWz6Zet57q555CG5Y6L57yp5byA5aeLXCIpO1xyXG4gICAgICAgIGxldCBleHRzID0gW1wiLmpwZ1wiLCBcIi5wbmdcIiwgXCIuanBlZ1wiLCBcIi5wYWNcIl07XHJcbiAgICAgICAgbGV0IGZpbHRlciA9IChmaWxlOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgbGV0IGV4dCA9IHBhdGguZXh0bmFtZShmaWxlKTtcclxuICAgICAgICAgICAgcmV0dXJuIGV4dHMuaW5jbHVkZXMoZXh0KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IGFsbEZpbGVzID0gVXRpbHMuZ2V0QWxsRmlsZXMoVXRpbHMuUHJvamVjdFBhdGggKyBcIi9hc3NldHNcIiwgZmlsdGVyKTtcclxuICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgYWxsRmlsZXMpIHtcclxuICAgICAgICAgICAgaWYgKHBhdGguYmFzZW5hbWUoZmlsZSkuc3RhcnRzV2l0aChcIl9fXCIpKSBjb250aW51ZTtcclxuICAgICAgICAgICAgbGV0IG1ldGFGaWxlID0gZmlsZSArIFwiLm1ldGFcIjtcclxuICAgICAgICAgICAgbGV0IG9iaiA9IGZzLnJlYWRKU09OU3luYyhtZXRhRmlsZSk7XHJcbiAgICAgICAgICAgIGxldCBjb21wcmVzc1NldHRpbmdzOiB7IHVzZUNvbXByZXNzVGV4dHVyZTogYm9vbGVhbiwgcHJlc2V0SWQ6IHN0cmluZyB9ID0gb2JqLnVzZXJEYXRhLmNvbXByZXNzU2V0dGluZ3M7XHJcbiAgICAgICAgICAgIGlmIChjb21wcmVzc1NldHRpbmdzICYmIGNvbXByZXNzU2V0dGluZ3MudXNlQ29tcHJlc3NUZXh0dXJlKSB7XHJcbiAgICAgICAgICAgICAgICBjb21wcmVzc1NldHRpbmdzLnVzZUNvbXByZXNzVGV4dHVyZSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgZnMud3JpdGVKU09OU3luYyhtZXRhRmlsZSwgb2JqLCB7IHNwYWNlczogMiB9KTtcclxuICAgICAgICAgICAgICAgIFV0aWxzLnJlZnJlc2hBc3NldChmaWxlKTtcclxuICAgICAgICAgICAgICAgIExvZ2dlci5pbmZvKFwi5YWz6Zet57q555CG5Y6L57ypXCIsIGZpbGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIExvZ2dlci5pbmZvKFwi5YWz6Zet57q555CG5Y6L57yp57uT5p2fXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgc2V0VGV4Q29tcHJlc3MoKSB7XHJcbiAgICAgICAgbGV0IHByZXNldElkOiBzdHJpbmcgPSBFZGl0b3IuQ2xpcGJvYXJkLnJlYWQoXCJ0ZXh0XCIpIGFzIHN0cmluZztcclxuICAgICAgICBpZiAocHJlc2V0SWQubGVuZ3RoICE9IDIyKSB7XHJcbiAgICAgICAgICAgIExvZ2dlci53YXJuKFwi6K+35YWI5ou36LSd5LiA5Liq57q555CG5Y6L57yp6YWN572u55qEMjLkvY1VVUlE5Yiw5Ymq5YiH5p2/KOmhueebruiuvue9ri3ljovnvKnnurnnkIYt6YWN572u5Y6L57yp6aKE6K6+6ZuGKVwiKVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIExvZ2dlci5pbmZvKFwi57q555CG5Y6L57yp5pa55qGIVVVJRDpcIiwgcHJlc2V0SWQpO1xyXG4gICAgICAgICAgICBsZXQgZXh0cyA9IFtcIi5qcGdcIiwgXCIucG5nXCIsIFwiLmpwZWdcIiwgXCIucGFjXCJdO1xyXG4gICAgICAgICAgICBsZXQgZmlsdGVyID0gKGZpbGU6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgbGV0IGV4dCA9IHBhdGguZXh0bmFtZShmaWxlKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBleHRzLmluY2x1ZGVzKGV4dCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgbGV0IGFsbEZpbGVzID0gVXRpbHMuZ2V0QWxsRmlsZXMoVXRpbHMuUHJvamVjdFBhdGggKyBcIi9hc3NldHNcIiwgZmlsdGVyKTtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGFsbEZpbGVzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAocGF0aC5iYXNlbmFtZShmaWxlKS5zdGFydHNXaXRoKFwiX19cIikpIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgbGV0IG1ldGFGaWxlID0gZmlsZSArIFwiLm1ldGFcIjtcclxuICAgICAgICAgICAgICAgIGxldCBvYmogPSBmcy5yZWFkSlNPTlN5bmMobWV0YUZpbGUpO1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBjb21wcmVzc1NldHRpbmdzOiB7IHVzZUNvbXByZXNzVGV4dHVyZTogYm9vbGVhbiwgcHJlc2V0SWQ6IHN0cmluZyB9ID0gb2JqLnVzZXJEYXRhLmNvbXByZXNzU2V0dGluZ3M7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWNvbXByZXNzU2V0dGluZ3MgfHwgIWNvbXByZXNzU2V0dGluZ3MudXNlQ29tcHJlc3NUZXh0dXJlIHx8IGNvbXByZXNzU2V0dGluZ3MucHJlc2V0SWQgIT0gcHJlc2V0SWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgbmV3Q29tcHJlc3NTZXR0aW5nczogeyB1c2VDb21wcmVzc1RleHR1cmU6IGJvb2xlYW4sIHByZXNldElkOiBzdHJpbmcgfSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlQ29tcHJlc3NUZXh0dXJlOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmVzZXRJZDogcHJlc2V0SWRcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgb2JqLnVzZXJEYXRhLmNvbXByZXNzU2V0dGluZ3MgPSBuZXdDb21wcmVzc1NldHRpbmdzO1xyXG4gICAgICAgICAgICAgICAgICAgIGZzLndyaXRlSlNPTlN5bmMobWV0YUZpbGUsIG9iaiwgeyBzcGFjZXM6IDIgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgVXRpbHMucmVmcmVzaEFzc2V0KGZpbGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIExvZ2dlci5pbmZvKGDnurnnkIbljovnvKnorr7nva4gICR7ZmlsZX1gKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBMb2dnZXIuaW5mbyhcIuiuvue9rue6ueeQhuWOi+e8qee7k+adn1wiKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy/liIfmjaLphY3nva7lvIDlhbNcclxuICAgIHB1YmxpYyBzdGF0aWMgc2V0U3dpdGNoKGtleTogc3RyaW5nLCBkZXNjOiBzdHJpbmcpIHtcclxuICAgICAgICBsZXQgdmFsdWUgPSAhQ29uZmlnLmdldChrZXksIGZhbHNlKTtcclxuICAgICAgICBDb25maWcuc2V0KGtleSwgdmFsdWUpXHJcbiAgICAgICAgY29uc29sZS5sb2coYCR7ZGVzYyB8fCBrZXl9OiAke3ZhbHVlID8gXCLlvIBcIiA6IFwi5YWzXCJ9YCk7XHJcbiAgICB9XHJcblxyXG5cclxufSJdfQ==