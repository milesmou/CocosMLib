"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Utils = void 0;
const child_process_1 = __importDefault(require("child_process"));
const crypto_1 = __importDefault(require("crypto"));
const fs_extra_1 = __importDefault(require("fs-extra"));
const path_1 = __importDefault(require("path"));
const Logger_1 = require("./Logger");
class Utils {
    static get ProjectPath() {
        if (!this.projectPath)
            this.projectPath = this.toUniSeparator(Editor.Project.path);
        return this.projectPath;
    }
    /** 是否原生平台 */
    static isNative(platform) {
        switch (platform) {
            case "windows":
            case "mac":
            case "linux":
            case "android":
            case "ios":
            case "ohos":
            case "harmonyos-next":
                return true;
        }
        return false;
    }
    /** 是否小游戏平台 */
    static isMinigame(platform) {
        switch (platform) {
            case "wechatgame":
            case "wechatprogram":
            case "oppo-mini-game":
            case "vivo-mini-game":
            case "huawei-quick-game":
            case "migu-mini-game":
            case "alipay-mini-game":
            case "taobao-creative-app":
            case "taobao-mini-game":
            case "xiaomi-quick-game":
            case "baidu-mini-game":
            case "bytedance-mini-game":
                return true;
        }
        return false;
    }
    /** 执行终端命令 */
    static exeCMD(workDir, cmd, onMsg) {
        let p = new Promise((resolve, reject) => {
            let result = child_process_1.default.exec(cmd, { cwd: workDir });
            result.stdout.on("data", (data) => {
                let d = data.toString();
                onMsg && onMsg(d);
                if (d.indexOf("continue") > -1) {
                    result.kill();
                }
            });
            result.stderr.on("data", (data) => {
                if (globalThis['Editor']) {
                    Logger_1.Logger.error(data.toString());
                }
                else {
                    Logger_1.Logger.error(data.toString());
                }
            });
            result.on("close", (code) => {
                resolve(code ? code : 0);
            });
        });
        return p;
    }
    /** 获取指定目录下所有文件 */
    static getAllFiles(dir, filter, topDirOnly = false) {
        dir = this.toAbsolutePath(dir);
        let files = [];
        if (!fs_extra_1.default.existsSync(dir))
            return files;
        let walkSync = (currentDir, callback) => {
            fs_extra_1.default.readdirSync(currentDir, { withFileTypes: true }).forEach(dirent => {
                let p = path_1.default.join(currentDir, dirent.name);
                if (dirent.isFile()) {
                    callback(p);
                }
                else if (dirent.isDirectory()) {
                    if (topDirOnly)
                        return;
                    walkSync(p, callback);
                }
            });
        };
        walkSync(dir, file => {
            if (file.endsWith(".meta"))
                return;
            file = this.toUniSeparator(file);
            if (!filter || filter(file)) {
                files.push(file);
            }
        });
        return files;
    }
    /** 获取指定目录下所有目录 */
    static getAllDirs(dir, filter, topDirOnly = false) {
        dir = this.toAbsolutePath(dir);
        let dirs = [];
        if (!fs_extra_1.default.existsSync(dir))
            return dirs;
        let walkSync = (currentDir, callback) => {
            fs_extra_1.default.readdirSync(currentDir, { withFileTypes: true }).forEach(dirent => {
                let p = path_1.default.join(currentDir, dirent.name);
                if (dirent.isDirectory()) {
                    callback(p);
                    if (topDirOnly)
                        return;
                    walkSync(p, callback);
                }
            });
        };
        walkSync(dir, subDir => {
            subDir = this.toUniSeparator(subDir);
            if (!filter || filter(subDir)) {
                dirs.push(subDir);
            }
        });
        return dirs;
    }
    /** 查找指定目录下的一个文件 */
    static findFile(dir, filter, topDirOnly = false) {
        dir = this.toAbsolutePath(dir);
        let filePath = null;
        if (!fs_extra_1.default.existsSync(dir))
            return filePath;
        let walkSync = (currentDir, callback) => {
            let dirents = fs_extra_1.default.readdirSync(currentDir, { withFileTypes: true });
            for (const dirent of dirents) {
                let p = path_1.default.join(currentDir, dirent.name);
                if (dirent.isFile()) {
                    if (callback(p))
                        break;
                }
                else if (dirent.isDirectory()) {
                    if (topDirOnly)
                        return;
                    walkSync(p, callback);
                }
            }
        };
        walkSync(dir, file => {
            if (file.endsWith(".meta"))
                return false;
            if (!filter || filter(file)) {
                filePath = this.toUniSeparator(file);
                return true;
            }
            return false;
        });
        return filePath;
    }
    /** 根据文件路径找到追加了Md5值的实际文件路径 */
    static resolveFilePath(filePath) {
        let result = filePath;
        let dir = path_1.default.dirname(filePath);
        if (fs_extra_1.default.existsSync(dir)) {
            let basename = path_1.default.basename(filePath);
            let ext = path_1.default.extname(filePath);
            let name = basename.replace(ext, ".");
            let reg = new RegExp(`${name}[A-Za-z0-9]{5}${ext}`);
            let dirents = fs_extra_1.default.readdirSync(dir, { withFileTypes: true });
            for (const dirent of dirents) {
                let p = path_1.default.join(dir, dirent.name);
                if (dirent.isFile()) {
                    if (dirent.name == basename) {
                        break;
                    }
                    else {
                        if (reg.test(dirent.name)) {
                            result = p;
                            break;
                        }
                    }
                }
            }
        }
        return this.toUniSeparator(result);
    }
    /** 将追加了Md5的文件路径还原为正常的文件路径 */
    static restoreFilePath(filePath) {
        let ext = path_1.default.extname(filePath);
        let p = filePath.replace(ext, "");
        let reg = new RegExp(/.+\.[A-Za-z0-9]{5}/);
        if (reg.test(p)) {
            let index = p.lastIndexOf(".");
            return p.substring(0, index) + ext;
        }
        else {
            return filePath;
        }
    }
    /** 修改文件名，使其文件名后追加Md5值 */
    static appendMd5(filePath) {
        if (fs_extra_1.default.existsSync(filePath)) {
            let ext = path_1.default.extname(filePath);
            let p = filePath.replace(ext, "");
            let reg = new RegExp(/.+\.[A-Za-z0-9]{5}/);
            if (!reg.test(p)) {
                let md5 = crypto_1.default.createHash('md5').update(fs_extra_1.default.readFileSync(filePath)).digest('hex');
                let shortMd5 = md5.substring(0, 6);
                let newFilePath = p + "." + shortMd5 + ext;
                fs_extra_1.default.renameSync(filePath, newFilePath);
            }
        }
    }
    /** 修改文件名，移除其文件名后的Md5值 */
    static removeMd5(filePath) {
        if (fs_extra_1.default.existsSync(filePath)) {
            let newFilePath = this.restoreFilePath(filePath);
            fs_extra_1.default.renameSync(filePath, newFilePath);
        }
    }
    /** 刷新编辑器内的资源 */
    static refreshAsset(path) {
        if (!path.startsWith("db:") && fs_extra_1.default.statSync(path).isDirectory()) {
            let files = Utils.getAllFiles(path, null, true);
            for (const file of files) {
                Editor.Message.send("asset-db", "refresh-asset", this.toAssetDBUrl(file));
            }
        }
        else {
            Editor.Message.send("asset-db", "refresh-asset", this.toAssetDBUrl(path));
        }
    }
    /** 删除编辑器内的资源 */
    static deleteAsset(path) {
        Editor.Message.send("asset-db", "delete-asset", this.toAssetDBUrl(path));
    }
    /** 将本地文件路径转化为编辑器内资源路径 */
    static toAssetDBUrl(path) {
        if (path.startsWith("db://"))
            return path;
        else
            return path.replace(this.ProjectPath + "/", "db://");
    }
    /** 将编辑器内资源路径转化为本地文件路径 */
    static toAbsolutePath(dbUrlOprojUrl) {
        if (dbUrlOprojUrl.startsWith("db://"))
            return dbUrlOprojUrl.replace("db://", this.ProjectPath + "/");
        else if (dbUrlOprojUrl.startsWith("project://"))
            return dbUrlOprojUrl.replace("db://", this.ProjectPath + "/");
        else
            return dbUrlOprojUrl;
    }
    /** 统一路径分隔符为(/) */
    static toUniSeparator(path) {
        return path.replace(/\\/g, "/");
    }
    /** 统一换行符为(\n) */
    static toUniLineBrake(content) {
        return content.replace(/\\r\\n/g, "\n");
    }
    /** 获取文件或者目录所在的bundle路径 */
    static getBundlePath(filePath) {
        var _a;
        filePath = this.toUniSeparator(filePath);
        let dir = path_1.default.dirname(filePath);
        while (true) {
            let meta = dir + ".meta";
            if (fs_extra_1.default.existsSync(meta)) {
                let obj = fs_extra_1.default.readJsonSync(meta);
                if ((_a = obj === null || obj === void 0 ? void 0 : obj.userData) === null || _a === void 0 ? void 0 : _a.isBundle) {
                    return dir;
                }
                else {
                    dir = path_1.default.dirname(dir);
                    if (dir == this.projectPath)
                        break;
                }
            }
            else {
                break;
            }
        }
        return null;
    }
}
exports.Utils = Utils;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zb3VyY2UvdG9vbHMvVXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsa0VBQTBDO0FBQzFDLG9EQUE0QjtBQUM1Qix3REFBMEI7QUFDMUIsZ0RBQXdCO0FBRXhCLHFDQUFrQztBQUNsQyxNQUFhLEtBQUs7SUFHUCxNQUFNLEtBQUssV0FBVztRQUN6QixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVc7WUFBRSxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuRixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7SUFDNUIsQ0FBQztJQUVELGFBQWE7SUFDTixNQUFNLENBQUMsUUFBUSxDQUFDLFFBQWtCO1FBQ3JDLFFBQVEsUUFBUSxFQUFFO1lBQ2QsS0FBSyxTQUFTLENBQUM7WUFDZixLQUFLLEtBQUssQ0FBQztZQUNYLEtBQUssT0FBTyxDQUFDO1lBQ2IsS0FBSyxTQUFTLENBQUM7WUFDZixLQUFLLEtBQUssQ0FBQztZQUNYLEtBQUssTUFBTSxDQUFDO1lBQ1osS0FBSyxnQkFBZ0I7Z0JBQ2pCLE9BQU8sSUFBSSxDQUFDO1NBQ25CO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQztJQUVELGNBQWM7SUFDUCxNQUFNLENBQUMsVUFBVSxDQUFDLFFBQWtCO1FBQ3ZDLFFBQVEsUUFBUSxFQUFFO1lBQ2QsS0FBSyxZQUFZLENBQUM7WUFDbEIsS0FBSyxlQUFlLENBQUM7WUFDckIsS0FBSyxnQkFBZ0IsQ0FBQztZQUN0QixLQUFLLGdCQUFnQixDQUFDO1lBQ3RCLEtBQUssbUJBQW1CLENBQUM7WUFDekIsS0FBSyxnQkFBZ0IsQ0FBQztZQUN0QixLQUFLLGtCQUFrQixDQUFDO1lBQ3hCLEtBQUsscUJBQXFCLENBQUM7WUFDM0IsS0FBSyxrQkFBa0IsQ0FBQztZQUN4QixL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IGZyb20gXCJjaGlsZF9wcm9jZXNzXCI7XG5pbXBvcnQgY3J5cHRvIGZyb20gXCJjcnlwdG9cIjtcbmltcG9ydCBmcyBmcm9tIFwiZnMtZXh0cmFcIjtcbmltcG9ydCBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyBQbGF0Zm9ybSB9IGZyb20gXCIuLi8uLi9AY29jb3MvY3JlYXRvci10eXBlcy9lZGl0b3IvcGFja2FnZXMvYnVpbGRlci9AdHlwZXNcIjtcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gXCIuL0xvZ2dlclwiO1xuZXhwb3J0IGNsYXNzIFV0aWxzIHtcblxuICAgIHByaXZhdGUgc3RhdGljIHByb2plY3RQYXRoOiBzdHJpbmc7XG4gICAgcHVibGljIHN0YXRpYyBnZXQgUHJvamVjdFBhdGgoKSB7XG4gICAgICAgIGlmICghdGhpcy5wcm9qZWN0UGF0aCkgdGhpcy5wcm9qZWN0UGF0aCA9IHRoaXMudG9VbmlTZXBhcmF0b3IoRWRpdG9yLlByb2plY3QucGF0aCk7XG4gICAgICAgIHJldHVybiB0aGlzLnByb2plY3RQYXRoO1xuICAgIH1cblxuICAgIC8qKiDmmK/lkKbljp/nlJ/lubPlj7AgKi9cbiAgICBwdWJsaWMgc3RhdGljIGlzTmF0aXZlKHBsYXRmb3JtOiBQbGF0Zm9ybSkge1xuICAgICAgICBzd2l0Y2ggKHBsYXRmb3JtKSB7XG4gICAgICAgICAgICBjYXNlIFwid2luZG93c1wiOlxuICAgICAgICAgICAgY2FzZSBcIm1hY1wiOlxuICAgICAgICAgICAgY2FzZSBcImxpbnV4XCI6XG4gICAgICAgICAgICBjYXNlIFwiYW5kcm9pZFwiOlxuICAgICAgICAgICAgY2FzZSBcImlvc1wiOlxuICAgICAgICAgICAgY2FzZSBcIm9ob3NcIjpcbiAgICAgICAgICAgIGNhc2UgXCJoYXJtb255b3MtbmV4dFwiOlxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvKiog5piv5ZCm5bCP5ri45oiP5bmz5Y+wICovXG4gICAgcHVibGljIHN0YXRpYyBpc01pbmlnYW1lKHBsYXRmb3JtOiBQbGF0Zm9ybSkge1xuICAgICAgICBzd2l0Y2ggKHBsYXRmb3JtKSB7XG4gICAgICAgICAgICBjYXNlIFwid2VjaGF0Z2FtZVwiOlxuICAgICAgICAgICAgY2FzZSBcIndlY2hhdHByb2dyYW1cIjpcbiAgICAgICAgICAgIGNhc2UgXCJvcHBvLW1pbmktZ2FtZVwiOlxuICAgICAgICAgICAgY2FzZSBcInZpdm8tbWluaS1nYW1lXCI6XG4gICAgICAgICAgICBjYXNlIFwiaHVhd2VpLXF1aWNrLWdhbWVcIjpcbiAgICAgICAgICAgIGNhc2UgXCJtaWd1LW1pbmktZ2FtZVwiOlxuICAgICAgICAgICAgY2FzZSBcImFsaXBheS1taW5pLWdhbWVcIjpcbiAgICAgICAgICAgIGNhc2UgXCJ0YW9iYW8tY3JlYXRpdmUtYXBwXCI6XG4gICAgICAgICAgICBjYXNlIFwidGFvYmFvLW1pbmktZ2FtZVwiOlxuICAgICAgICAgICAgY2FzZSBcInhpYW9taS1xdWljay1nYW1lXCI6XG4gICAgICAgICAgICBjYXNlIFwiYmFpZHUtbWluaS1nYW1lXCI6XG4gICAgICAgICAgICBjYXNlIFwiYnl0ZWRhbmNlLW1pbmktZ2FtZVwiOlxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvKiog5omn6KGM57uI56uv5ZG95LukICovXG4gICAgcHVibGljIHN0YXRpYyBleGVDTUQod29ya0Rpcjogc3RyaW5nLCBjbWQ6IHN0cmluZywgb25Nc2c/OiAobXNnOiBzdHJpbmcpID0+IHZvaWQpIHtcbiAgICAgICAgbGV0IHAgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBsZXQgcmVzdWx0ID0gY2hpbGRfcHJvY2Vzcy5leGVjKGNtZCwgeyBjd2Q6IHdvcmtEaXIgfSk7XG4gICAgICAgICAgICByZXN1bHQuc3Rkb3V0Lm9uKFwiZGF0YVwiLCAoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBkID0gZGF0YS50b1N0cmluZygpO1xuICAgICAgICAgICAgICAgIG9uTXNnICYmIG9uTXNnKGQpO1xuICAgICAgICAgICAgICAgIGlmIChkLmluZGV4T2YoXCJjb250aW51ZVwiKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC5raWxsKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXN1bHQuc3RkZXJyLm9uKFwiZGF0YVwiLCAoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChnbG9iYWxUaGlzWydFZGl0b3InXSkge1xuICAgICAgICAgICAgICAgICAgICBMb2dnZXIuZXJyb3IoZGF0YS50b1N0cmluZygpKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBMb2dnZXIuZXJyb3IoZGF0YS50b1N0cmluZygpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJlc3VsdC5vbihcImNsb3NlXCIsIChjb2RlKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShjb2RlID8gY29kZSA6IDApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pXG4gICAgICAgIHJldHVybiBwO1xuICAgIH1cblxuICAgIC8qKiDojrflj5bmjIflrprnm67lvZXkuIvmiYDmnInmlofku7YgKi9cbiAgICBwdWJsaWMgc3RhdGljIGdldEFsbEZpbGVzKGRpcjogc3RyaW5nLCBmaWx0ZXI/OiAoZmlsZTogc3RyaW5nKSA9PiBib29sZWFuLCB0b3BEaXJPbmx5ID0gZmFsc2UpIHtcbiAgICAgICAgZGlyID0gdGhpcy50b0Fic29sdXRlUGF0aChkaXIpO1xuICAgICAgICBsZXQgZmlsZXM6IHN0cmluZ1tdID0gW107XG4gICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhkaXIpKSByZXR1cm4gZmlsZXM7XG4gICAgICAgIGxldCB3YWxrU3luYyA9IChjdXJyZW50RGlyOiBzdHJpbmcsIGNhbGxiYWNrOiAoZmlsZVBhdGg6IHN0cmluZykgPT4gdm9pZCkgPT4ge1xuICAgICAgICAgICAgZnMucmVhZGRpclN5bmMoY3VycmVudERpciwgeyB3aXRoRmlsZVR5cGVzOiB0cnVlIH0pLmZvckVhY2goZGlyZW50ID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgcCA9IHBhdGguam9pbihjdXJyZW50RGlyLCBkaXJlbnQubmFtZSk7XG4gICAgICAgICAgICAgICAgaWYgKGRpcmVudC5pc0ZpbGUoKSkge1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhwKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRpcmVudC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0b3BEaXJPbmx5KSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIHdhbGtTeW5jKHAsIGNhbGxiYWNrKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICB3YWxrU3luYyhkaXIsIGZpbGUgPT4ge1xuICAgICAgICAgICAgaWYgKGZpbGUuZW5kc1dpdGgoXCIubWV0YVwiKSkgcmV0dXJuO1xuICAgICAgICAgICAgZmlsZSA9IHRoaXMudG9VbmlTZXBhcmF0b3IoZmlsZSk7XG4gICAgICAgICAgICBpZiAoIWZpbHRlciB8fCBmaWx0ZXIoZmlsZSkpIHtcbiAgICAgICAgICAgICAgICBmaWxlcy5wdXNoKGZpbGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGZpbGVzO1xuICAgIH1cblxuXG5cbiAgICAvKiog6I635Y+W5oyH5a6a55uu5b2V5LiL5omA5pyJ55uu5b2VICovXG4gICAgcHVibGljIHN0YXRpYyBnZXRBbGxEaXJzKGRpcjogc3RyaW5nLCBmaWx0ZXI/OiAoZGlyOiBzdHJpbmcpID0+IGJvb2xlYW4sIHRvcERpck9ubHkgPSBmYWxzZSkge1xuICAgICAgICBkaXIgPSB0aGlzLnRvQWJzb2x1dGVQYXRoKGRpcik7XG4gICAgICAgIGxldCBkaXJzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZGlyKSkgcmV0dXJuIGRpcnM7XG4gICAgICAgIGxldCB3YWxrU3luYyA9IChjdXJyZW50RGlyOiBzdHJpbmcsIGNhbGxiYWNrOiAoZmlsZVBhdGg6IHN0cmluZykgPT4gdm9pZCkgPT4ge1xuICAgICAgICAgICAgZnMucmVhZGRpclN5bmMoY3VycmVudERpciwgeyB3aXRoRmlsZVR5cGVzOiB0cnVlIH0pLmZvckVhY2goZGlyZW50ID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgcCA9IHBhdGguam9pbihjdXJyZW50RGlyLCBkaXJlbnQubmFtZSk7XG4gICAgICAgICAgICAgICAgaWYgKGRpcmVudC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHApO1xuICAgICAgICAgICAgICAgICAgICBpZiAodG9wRGlyT25seSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB3YWxrU3luYyhwLCBjYWxsYmFjayk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIHdhbGtTeW5jKGRpciwgc3ViRGlyID0+IHtcbiAgICAgICAgICAgIHN1YkRpciA9IHRoaXMudG9VbmlTZXBhcmF0b3Ioc3ViRGlyKTtcbiAgICAgICAgICAgIGlmICghZmlsdGVyIHx8IGZpbHRlcihzdWJEaXIpKSB7XG4gICAgICAgICAgICAgICAgZGlycy5wdXNoKHN1YkRpcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZGlycztcbiAgICB9XG5cbiAgICAvKiog5p+l5om+5oyH5a6a55uu5b2V5LiL55qE5LiA5Liq5paH5Lu2ICovXG4gICAgcHVibGljIHN0YXRpYyBmaW5kRmlsZShkaXI6IHN0cmluZywgZmlsdGVyPzogKGZpbGU6IHN0cmluZykgPT4gYm9vbGVhbiwgdG9wRGlyT25seSA9IGZhbHNlKSB7XG4gICAgICAgIGRpciA9IHRoaXMudG9BYnNvbHV0ZVBhdGgoZGlyKTtcbiAgICAgICAgbGV0IGZpbGVQYXRoID0gbnVsbDtcbiAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKGRpcikpIHJldHVybiBmaWxlUGF0aDtcbiAgICAgICAgbGV0IHdhbGtTeW5jID0gKGN1cnJlbnREaXI6IHN0cmluZywgY2FsbGJhY2s6IChmaWxlUGF0aDogc3RyaW5nKSA9PiBib29sZWFuKSA9PiB7XG4gICAgICAgICAgICBsZXQgZGlyZW50cyA9IGZzLnJlYWRkaXJTeW5jKGN1cnJlbnREaXIsIHsgd2l0aEZpbGVUeXBlczogdHJ1ZSB9KTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgZGlyZW50IG9mIGRpcmVudHMpIHtcbiAgICAgICAgICAgICAgICBsZXQgcCA9IHBhdGguam9pbihjdXJyZW50RGlyLCBkaXJlbnQubmFtZSk7XG4gICAgICAgICAgICAgICAgaWYgKGRpcmVudC5pc0ZpbGUoKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2socCkpIGJyZWFrO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGlyZW50LmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRvcERpck9ubHkpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgd2Fsa1N5bmMocCwgY2FsbGJhY2spO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgd2Fsa1N5bmMoZGlyLCBmaWxlID0+IHtcbiAgICAgICAgICAgIGlmIChmaWxlLmVuZHNXaXRoKFwiLm1ldGFcIikpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIGlmICghZmlsdGVyIHx8IGZpbHRlcihmaWxlKSkge1xuICAgICAgICAgICAgICAgIGZpbGVQYXRoID0gdGhpcy50b1VuaVNlcGFyYXRvcihmaWxlKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBmaWxlUGF0aDtcbiAgICB9XG5cbiAgICAvKiog5qC55o2u5paH5Lu26Lev5b6E5om+5Yiw6L+95Yqg5LqGTWQ15YC855qE5a6e6ZmF5paH5Lu26Lev5b6EICovXG4gICAgcHVibGljIHN0YXRpYyByZXNvbHZlRmlsZVBhdGgoZmlsZVBhdGg6IHN0cmluZykge1xuICAgICAgICBsZXQgcmVzdWx0ID0gZmlsZVBhdGg7XG4gICAgICAgIGxldCBkaXIgPSBwYXRoLmRpcm5hbWUoZmlsZVBhdGgpO1xuICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhkaXIpKSB7XG4gICAgICAgICAgICBsZXQgYmFzZW5hbWUgPSBwYXRoLmJhc2VuYW1lKGZpbGVQYXRoKTtcbiAgICAgICAgICAgIGxldCBleHQgPSBwYXRoLmV4dG5hbWUoZmlsZVBhdGgpO1xuICAgICAgICAgICAgbGV0IG5hbWUgPSBiYXNlbmFtZS5yZXBsYWNlKGV4dCwgXCIuXCIpO1xuICAgICAgICAgICAgbGV0IHJlZyA9IG5ldyBSZWdFeHAoYCR7bmFtZX1bQS1aYS16MC05XXs1fSR7ZXh0fWApO1xuICAgICAgICAgICAgbGV0IGRpcmVudHMgPSBmcy5yZWFkZGlyU3luYyhkaXIsIHsgd2l0aEZpbGVUeXBlczogdHJ1ZSB9KTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgZGlyZW50IG9mIGRpcmVudHMpIHtcbiAgICAgICAgICAgICAgICBsZXQgcCA9IHBhdGguam9pbihkaXIsIGRpcmVudC5uYW1lKTtcbiAgICAgICAgICAgICAgICBpZiAoZGlyZW50LmlzRmlsZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkaXJlbnQubmFtZSA9PSBiYXNlbmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVnLnRlc3QoZGlyZW50Lm5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gcDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy50b1VuaVNlcGFyYXRvcihyZXN1bHQpO1xuICAgIH1cblxuICAgIC8qKiDlsIbov73liqDkuoZNZDXnmoTmlofku7bot6/lvoTov5jljp/kuLrmraPluLjnmoTmlofku7bot6/lvoQgKi9cbiAgICBwdWJsaWMgc3RhdGljIHJlc3RvcmVGaWxlUGF0aChmaWxlUGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGxldCBleHQgPSBwYXRoLmV4dG5hbWUoZmlsZVBhdGgpO1xuICAgICAgICBsZXQgcCA9IGZpbGVQYXRoLnJlcGxhY2UoZXh0LCBcIlwiKTtcbiAgICAgICAgbGV0IHJlZyA9IG5ldyBSZWdFeHAoLy4rXFwuW0EtWmEtejAtOV17NX0vKTtcbiAgICAgICAgaWYgKHJlZy50ZXN0KHApKSB7XG4gICAgICAgICAgICBsZXQgaW5kZXggPSBwLmxhc3RJbmRleE9mKFwiLlwiKVxuICAgICAgICAgICAgcmV0dXJuIHAuc3Vic3RyaW5nKDAsIGluZGV4KSArIGV4dDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBmaWxlUGF0aDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKiDkv67mlLnmlofku7blkI3vvIzkvb/lhbbmlofku7blkI3lkI7ov73liqBNZDXlgLwgKi9cbiAgICBwdWJsaWMgc3RhdGljIGFwcGVuZE1kNShmaWxlUGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGlmIChmcy5leGlzdHNTeW5jKGZpbGVQYXRoKSkge1xuICAgICAgICAgICAgbGV0IGV4dCA9IHBhdGguZXh0bmFtZShmaWxlUGF0aCk7XG4gICAgICAgICAgICBsZXQgcCA9IGZpbGVQYXRoLnJlcGxhY2UoZXh0LCBcIlwiKTtcbiAgICAgICAgICAgIGxldCByZWcgPSBuZXcgUmVnRXhwKC8uK1xcLltBLVphLXowLTldezV9Lyk7XG4gICAgICAgICAgICBpZiAoIXJlZy50ZXN0KHApKSB7XG4gICAgICAgICAgICAgICAgbGV0IG1kNSA9IGNyeXB0by5jcmVhdGVIYXNoKCdtZDUnKS51cGRhdGUoZnMucmVhZEZpbGVTeW5jKGZpbGVQYXRoKSBhcyBhbnkpLmRpZ2VzdCgnaGV4Jyk7XG4gICAgICAgICAgICAgICAgbGV0IHNob3J0TWQ1ID0gbWQ1LnN1YnN0cmluZygwLCA2KTtcbiAgICAgICAgICAgICAgICBsZXQgbmV3RmlsZVBhdGggPSBwICsgXCIuXCIgKyBzaG9ydE1kNSArIGV4dDtcbiAgICAgICAgICAgICAgICBmcy5yZW5hbWVTeW5jKGZpbGVQYXRoLCBuZXdGaWxlUGF0aCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKiog5L+u5pS55paH5Lu25ZCN77yM56e76Zmk5YW25paH5Lu25ZCN5ZCO55qETWQ15YC8ICovXG4gICAgcHVibGljIHN0YXRpYyByZW1vdmVNZDUoZmlsZVBhdGg6IHN0cmluZykge1xuICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhmaWxlUGF0aCkpIHtcbiAgICAgICAgICAgIGxldCBuZXdGaWxlUGF0aCA9IHRoaXMucmVzdG9yZUZpbGVQYXRoKGZpbGVQYXRoKTtcbiAgICAgICAgICAgIGZzLnJlbmFtZVN5bmMoZmlsZVBhdGgsIG5ld0ZpbGVQYXRoKTtcbiAgICAgICAgfVxuICAgIH1cblxuXG5cbiAgICAvKiog5Yi35paw57yW6L6R5Zmo5YaF55qE6LWE5rqQICovXG4gICAgcHVibGljIHN0YXRpYyByZWZyZXNoQXNzZXQocGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGlmICghcGF0aC5zdGFydHNXaXRoKFwiZGI6XCIpICYmIGZzLnN0YXRTeW5jKHBhdGgpLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgICAgIGxldCBmaWxlcyA9IFV0aWxzLmdldEFsbEZpbGVzKHBhdGgsIG51bGwsIHRydWUpO1xuICAgICAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICAgICAgICAgICAgRWRpdG9yLk1lc3NhZ2Uuc2VuZChcImFzc2V0LWRiXCIsIFwicmVmcmVzaC1hc3NldFwiLCB0aGlzLnRvQXNzZXREQlVybChmaWxlKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBFZGl0b3IuTWVzc2FnZS5zZW5kKFwiYXNzZXQtZGJcIiwgXCJyZWZyZXNoLWFzc2V0XCIsIHRoaXMudG9Bc3NldERCVXJsKHBhdGgpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKiDliKDpmaTnvJbovpHlmajlhoXnmoTotYTmupAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGRlbGV0ZUFzc2V0KHBhdGg6IHN0cmluZykge1xuICAgICAgICBFZGl0b3IuTWVzc2FnZS5zZW5kKFwiYXNzZXQtZGJcIiwgXCJkZWxldGUtYXNzZXRcIiwgdGhpcy50b0Fzc2V0REJVcmwocGF0aCkpO1xuICAgIH1cblxuICAgIC8qKiDlsIbmnKzlnLDmlofku7bot6/lvoTovazljJbkuLrnvJbovpHlmajlhoXotYTmupDot6/lvoQgKi9cbiAgICBwdWJsaWMgc3RhdGljIHRvQXNzZXREQlVybChwYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKHBhdGguc3RhcnRzV2l0aChcImRiOi8vXCIpKSByZXR1cm4gcGF0aDtcbiAgICAgICAgZWxzZSByZXR1cm4gcGF0aC5yZXBsYWNlKHRoaXMuUHJvamVjdFBhdGggKyBcIi9cIiwgXCJkYjovL1wiKTtcbiAgICB9XG5cbiAgICAvKiog5bCG57yW6L6R5Zmo5YaF6LWE5rqQ6Lev5b6E6L2s5YyW5Li65pys5Zyw5paH5Lu26Lev5b6EICovXG4gICAgcHVibGljIHN0YXRpYyB0b0Fic29sdXRlUGF0aChkYlVybE9wcm9qVXJsOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKGRiVXJsT3Byb2pVcmwuc3RhcnRzV2l0aChcImRiOi8vXCIpKSByZXR1cm4gZGJVcmxPcHJvalVybC5yZXBsYWNlKFwiZGI6Ly9cIiwgdGhpcy5Qcm9qZWN0UGF0aCArIFwiL1wiKTtcbiAgICAgICAgZWxzZSBpZiAoZGJVcmxPcHJvalVybC5zdGFydHNXaXRoKFwicHJvamVjdDovL1wiKSkgcmV0dXJuIGRiVXJsT3Byb2pVcmwucmVwbGFjZShcImRiOi8vXCIsIHRoaXMuUHJvamVjdFBhdGggKyBcIi9cIik7XG4gICAgICAgIGVsc2UgcmV0dXJuIGRiVXJsT3Byb2pVcmw7XG4gICAgfVxuXG4gICAgLyoqIOe7n+S4gOi3r+W+hOWIhumalOespuS4uigvKSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgdG9VbmlTZXBhcmF0b3IocGF0aDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBwYXRoLnJlcGxhY2UoL1xcXFwvZywgXCIvXCIpO1xuICAgIH1cblxuICAgIC8qKiDnu5/kuIDmjaLooYznrKbkuLooXFxuKSAqL1xuICAgIHB1YmxpYyBzdGF0aWMgdG9VbmlMaW5lQnJha2UoY29udGVudDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBjb250ZW50LnJlcGxhY2UoL1xcXFxyXFxcXG4vZywgXCJcXG5cIik7XG4gICAgfVxuXG4gICAgLyoqIOiOt+WPluaWh+S7tuaIluiAheebruW9leaJgOWcqOeahGJ1bmRsZei3r+W+hCAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZ2V0QnVuZGxlUGF0aChmaWxlUGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGZpbGVQYXRoID0gdGhpcy50b1VuaVNlcGFyYXRvcihmaWxlUGF0aCk7XG4gICAgICAgIGxldCBkaXIgPSBwYXRoLmRpcm5hbWUoZmlsZVBhdGgpO1xuICAgICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICAgICAgbGV0IG1ldGEgPSBkaXIgKyBcIi5tZXRhXCI7XG4gICAgICAgICAgICBpZiAoZnMuZXhpc3RzU3luYyhtZXRhKSkge1xuICAgICAgICAgICAgICAgIGxldCBvYmogPSBmcy5yZWFkSnNvblN5bmMobWV0YSk7XG4gICAgICAgICAgICAgICAgaWYgKG9iaj8udXNlckRhdGE/LmlzQnVuZGxlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBkaXI7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZGlyID0gcGF0aC5kaXJuYW1lKGRpcik7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkaXIgPT0gdGhpcy5wcm9qZWN0UGF0aCkgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG59Il19